class CalculadoraDivisas{constructor(){this.tasasActuales=null;this.ultimaActualizacion=null;this.intervalId=null;this.init()}init(){this.obtenerTasas();this.intervalId=setInterval(()=>{this.obtenerTasas()},3e5);this.configurarEventListeners()}configurarEventListeners(){$(document).on("input",".monto-origen",e=>{this.calcularCambio(e.target)});$(document).on("change",".moneda-origen, .moneda-destino",e=>{const t=$(e.target).closest(".calculadora-container");this.calcularCambioContainer(t)});$(document).on("change",".tipo-operacion",e=>{const t=$(e.target).closest(".calculadora-container");this.actualizarTipoOperacion(t)});$(document).on("change",".cuenta-selector",e=>{const t=$(e.target).closest(".calculadora-container");this.validarFondos(t)})}async obtenerTasas(){try{const e=await fetch("/divisas/tasas_actuales"),t=await e.json();t.success?(this.tasasActuales=t.tasas,this.ultimaActualizacion=new Date,this.actualizarWidgetTasas(),console.log("Tasas actualizadas:",this.tasasActuales)):(console.error("Error obteniendo tasas:",t.error),this.mostrarError("Error obteniendo tasas de cambio"))}catch(e){console.error("Error en petición de tasas:",e),this.mostrarError("Error de conexión al obtener tasas")}}actualizarWidgetTasas(){this.tasasActuales&&($(".tasa-usd-ves").text(this.formatearTasa(this.tasasActuales.usd_ves)),$(".tasa-eur-ves").text(this.formatearTasa(this.tasasActuales.eur_ves)),$(".fecha-actualizacion").text(this.formatearFechaHora(this.tasasActuales.fecha,this.tasasActuales.hora)),$(".fuente-tasa").text(this.tasasActuales.fuente),$(".estado-tasas").removeClass("text-danger").addClass("text-success").text("Actualizado"))}async calcularCambio(e){const t=$(e).closest(".calculadora-container");await this.calcularCambioContainer(t)}async calcularCambioContainer(e){try{const t=parseFloat(e.find(".monto-origen").val())||0,a=e.find(".moneda-origen").val(),s=e.find(".moneda-destino").val(),n=e.find(".tipo-operacion").val();if(t<=0)return void this.limpiarResultados(e);if(!a||!s||!n)return void this.limpiarResultados(e);e.find(".calculando-indicator").show();const o=await fetch("/divisas/calcular_cambio",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({monto:t,moneda_origen:a,moneda_destino:s,tipo_operacion:n})}),r=await o.json();r.success?(this.mostrarResultados(e,r),await this.validarFondos(e)):this.mostrarErrorCalculadora(e,r.error)}catch(t){console.error("Error calculando cambio:",t),this.mostrarErrorCalculadora(e,"Error de conexión")}finally{e.find(".calculando-indicator").hide()}}mostrarResultados(e,t){e.find(".monto-destino").val(this.formatearMonto(t.monto_convertido)),e.find(".comision-calculada").text(this.formatearMonto(t.comision)),e.find(".total-debitado").text(this.formatearMonto(t.total_debitado)),e.find(".tasa-aplicada").text(this.formatearTasa(t.tasa_aplicada)),e.find(".info-tasa").show(),e.find(".fecha-tasa").text(`${t.fecha_tasa} ${t.hora_tasa}`),e.find(".resumen-operacion").show(),e.find(".error-calculadora").hide()}mostrarErrorCalculadora(e,t){e.find(".error-calculadora").text(t).show(),this.limpiarResultados(e)}limpiarResultados(e){e.find(".monto-destino").val(""),e.find(".comision-calculada").text("0.00"),e.find(".total-debitado").text("0.00"),e.find(".tasa-aplicada").text("0.0000"),e.find(".info-tasa").hide(),e.find(".resumen-operacion").hide(),e.find(".validacion-fondos").hide()}async validarFondos(e){try{const t=e.find(".cuenta-selector").val(),a=parseFloat(e.find(".total-debitado").text())||0,s=e.find(".tipo-operacion").val();if(!t||a<=0)return void e.find(".validacion-fondos").hide();let n;"compra"===s?n="VES":n=e.find(".moneda-origen").val();const o=await fetch("/divisas/validar_fondos",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({cuenta_id:t,monto:a,moneda:n})}),r=await o.json();r.success?this.mostrarValidacionFondos(e,r,n):this.mostrarErrorValidacion(e,r.error)}catch(t){console.error("Error validando fondos:",t),this.mostrarErrorValidacion(e,"Error validando fondos")}}mostrarValidacionFondos(e,t,a){const s=e.find(".validacion-fondos");s.show(),t.fondos_suficientes?(s.removeClass("alert-danger").addClass("alert-success"),s.find(".icono-validacion").removeClass("fa-times-circle").addClass("fa-check-circle"),s.find(".mensaje-validacion").text("Fondos suficientes"),s.find(".detalle-fondos").text(`Saldo disponible: ${this.formatearMonto(t.saldo_disponible)} ${a}`),e.find(".btn-confirmar-transaccion").prop("disabled",!1)):(s.removeClass("alert-success").addClass("alert-danger"),s.find(".icono-validacion").removeClass("fa-check-circle").addClass("fa-times-circle"),s.find(".mensaje-validacion").text("Fondos insuficientes"),s.find(".detalle-fondos").text(`Saldo disponible: ${this.formatearMonto(t.saldo_disponible)} ${a} | Faltante: ${this.formatearMonto(Math.abs(t.diferencia))} ${a}`),e.find(".btn-confirmar-transaccion").prop("disabled",!0))}mostrarErrorValidacion(e,t){const a=e.find(".validacion-fondos");a.show().removeClass("alert-success").addClass("alert-warning"),a.find(".icono-validacion").removeClass("fa-check-circle fa-times-circle").addClass("fa-exclamation-triangle"),a.find(".mensaje-validacion").text("Error en validación"),a.find(".detalle-fondos").text(t),e.find(".btn-confirmar-transaccion").prop("disabled",!0)}actualizarTipoOperacion(e){const t=e.find(".tipo-operacion").val();"compra"===t?(e.find(".moneda-origen").val("VES").prop("disabled",!0),e.find(".moneda-destino").prop("disabled",!1),e.find(".label-monto-origen").text("Monto en VES a cambiar:"),e.find(".label-monto-destino").text("Recibirá:")):"venta"===t&&(e.find(".moneda-origen").prop("disabled",!1),e.find(".moneda-destino").val("VES").prop("disabled",!0),e.find(".label-monto-origen").text("Monto en divisa a vender:"),e.find(".label-monto-destino").text("Recibirá en VES:")),this.calcularCambioContainer(e)}formatearMonto(e){return parseFloat(e).toLocaleString("es-VE",{minimumFractionDigits:2,maximumFractionDigits:2})}formatearTasa(e){return parseFloat(e).toLocaleString("es-VE",{minimumFractionDigits:4,maximumFractionDigits:4})}formatearFechaHora(e,t){try{return new Date(`${e}T${t}`).toLocaleString("es-VE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch(a){return`${e} ${t}`}}mostrarError(e){$(".estado-tasas").removeClass("text-success").addClass("text-danger").text("Error"),"undefined"!=typeof toastr?toastr.error(e):console.error(e)}destruir(){this.intervalId&&clearInterval(this.intervalId)}}window.CalculadoraDivisas=CalculadoraDivisas;function inicializarCalculadora(){window.calculadoraDivisas&&window.calculadoraDivisas.destruir(),window.calculadoraDivisas=new CalculadoraDivisas}function crearWidgetTasas(e){const t=document.getElementById(e);t&&(t.innerHTML='\n        <div class="card border-warning">\n            <div class="card-header bg-warning text-dark">\n                <h5 class="card-title mb-0">\n                    <i class="fas fa-exchange-alt"></i> Tasas de Cambio\n                </h5>\n            </div>\n            <div class="card-body">\n                <div class="row">\n                    <div class="col-md-6">\n                        <div class="text-center">\n                            <h6>USD/VES</h6>\n                            <h4 class="text-primary tasa-usd-ves">---.----</h4>\n                        </div>\n                    </div>\n                    <div class="col-md-6">\n                        <div class="text-center">\n                            <h6>EUR/VES</h6>\n                            <h4 class="text-info tasa-eur-ves">---.----</h4>\n                        </div>\n                    </div>\n                </div>\n                <hr>\n                <div class="row">\n                    <div class="col-12">\n                        <small class="text-muted">\n                            <i class="fas fa-clock"></i> \n                            Actualizado: <span class="fecha-actualizacion">--</span>\n                        </small>\n                        <br>\n                        <small class="text-muted">\n                            <i class="fas fa-source"></i> \n                            Fuente: <span class="fuente-tasa">--</span>\n                        </small>\n                        <br>\n                        <small class="estado-tasas text-muted">Cargando...</small>\n                    </div>\n                </div>\n            </div>\n        </div>\n    ')}function crearCalculadoraCompleta(e,t="compra"){const a=document.getElementById(e);a&&(a.innerHTML=`\n        <div class="calculadora-container">\n            <div class="card">\n                <div class="card-header">\n                    <h5 class="card-title">\n                        <i class="fas fa-calculator"></i> \n                        Calculadora de ${"compra"===t?"Compra":"Venta"} de Divisas\n                    </h5>\n                </div>\n                <div class="card-body">\n                    <!-- Selector de tipo de operación -->\n                    <div class="form-group">\n                        <label for="tipo-operacion">Tipo de Operación:</label>\n                        <select class="form-control tipo-operacion" id="tipo-operacion">\n                            <option value="compra" ${"compra"===t?"selected":""}>Compra de Divisas</option>\n                            <option value="venta" ${"venta"===t?"selected":""}>Venta de Divisas</option>\n                        </select>\n                    </div>\n\n                    <!-- Selector de cuenta -->\n                    <div class="form-group">\n                        <label for="cuenta-selector">Cuenta:</label>\n                        <select class="form-control cuenta-selector" id="cuenta-selector" required>\n                            <option value="">Seleccione una cuenta</option>\n                        </select>\n                    </div>\n\n                    <div class="row">\n                        <div class="col-md-6">\n                            <!-- Monto origen -->\n                            <div class="form-group">\n                                <label class="label-monto-origen">Monto a cambiar:</label>\n                                <div class="input-group">\n                                    <input type="number" class="form-control monto-origen" \n                                           placeholder="0.00" step="0.01" min="0.01">\n                                    <div class="input-group-append">\n                                        <select class="form-control moneda-origen">\n                                            <option value="VES">VES</option>\n                                            <option value="USD">USD</option>\n                                            <option value="EUR">EUR</option>\n                                        </select>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="col-md-6">\n                            <!-- Monto destino -->\n                            <div class="form-group">\n                                <label class="label-monto-destino">Recibirá:</label>\n                                <div class="input-group">\n                                    <input type="text" class="form-control monto-destino" \n                                           placeholder="0.00" readonly>\n                                    <div class="input-group-append">\n                                        <select class="form-control moneda-destino">\n                                            <option value="VES">VES</option>\n                                            <option value="USD">USD</option>\n                                            <option value="EUR">EUR</option>\n                                        </select>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- Indicador de cálculo -->\n                    <div class="calculando-indicator text-center" style="display: none;">\n                        <i class="fas fa-spinner fa-spin"></i> Calculando...\n                    </div>\n\n                    <!-- Error de calculadora -->\n                    <div class="alert alert-danger error-calculadora" style="display: none;"></div>\n\n                    <!-- Información de la tasa -->\n                    <div class="info-tasa" style="display: none;">\n                        <div class="card bg-light">\n                            <div class="card-body">\n                                <h6>Información de la Operación</h6>\n                                <div class="row">\n                                    <div class="col-md-3">\n                                        <strong>Tasa Aplicada:</strong><br>\n                                        <span class="tasa-aplicada">0.0000</span>\n                                    </div>\n                                    <div class="col-md-3">\n                                        <strong>Comisión:</strong><br>\n                                        <span class="comision-calculada">0.00</span>\n                                    </div>\n                                    <div class="col-md-3">\n                                        <strong>Total a Debitar:</strong><br>\n                                        <span class="total-debitado">0.00</span>\n                                    </div>\n                                    <div class="col-md-3">\n                                        <strong>Fecha/Hora Tasa:</strong><br>\n                                        <small class="fecha-tasa">--</small>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- Validación de fondos -->\n                    <div class="validacion-fondos alert" style="display: none;">\n                        <i class="fas icono-validacion"></i>\n                        <strong class="mensaje-validacion"></strong><br>\n                        <small class="detalle-fondos"></small>\n                    </div>\n\n                    <!-- Resumen de operación -->\n                    <div class="resumen-operacion" style="display: none;">\n                        <hr>\n                        <button type="button" class="btn btn-primary btn-confirmar-transaccion" disabled>\n                            <i class="fas fa-check"></i> Confirmar Transacción\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `)}$(document).ready(function(){window.location.pathname.includes("/divisas/")&&inicializarCalculadora()});