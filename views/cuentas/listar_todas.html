{{extend 'layout.html'}}

<div class="container-fluid">
    <!-- Header de la página -->
    <div class="page-header fade-in-up">
        <div class="row align-items-center">
            <div class="col-12">
                <h1>
                    <i class="fas fa-university me-3"></i>Gestión de Cuentas
                </h1>
                <p class="lead mb-0">Administración completa de todas las cuentas bancarias del sistema</p>
            </div>
        </div>
    </div>

    {{if response.flash:}}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info alert-dismissible fade show">
                {{=response.flash}}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>
    {{pass}}

    <!-- Filtros de búsqueda funcionales -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filtros de Búsqueda
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{{=URL('cuentas', 'listar_todas')}}">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Buscar general</label>
                                    <input type="text" name="buscar" class="form-control" 
                                           placeholder="Cédula, nombre o email" value="{{=XML(buscar or '', sanitize=True)}}" maxlength="100">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Número de cuenta</label>
                                    <input type="text" name="numero_cuenta" class="form-control" 
                                           placeholder="Número de cuenta" value="{{=XML(numero_cuenta or '', sanitize=True)}}" maxlength="25">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Tipo de cuenta</label>
                                    <select name="tipo" class="form-control">
                                        <option value="todos" {{='selected' if (tipo or 'todos') == 'todos' else ''}}>Todos los tipos</option>
                                        <option value="corriente" {{='selected' if (tipo or 'todos') == 'corriente' else ''}}>Corriente</option>
                                        <option value="ahorro" {{='selected' if (tipo or 'todos') == 'ahorro' else ''}}>Ahorro</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Estado</label>
                                    <select name="estado" class="form-control">
                                        <option value="todos" {{='selected' if (estado or 'todos') == 'todos' else ''}}>Todos los estados</option>
                                        <option value="activa" {{='selected' if (estado or 'todos') == 'activa' else ''}}>Activa</option>
                                        <option value="inactiva" {{='selected' if (estado or 'todos') == 'inactiva' else ''}}>Inactiva</option>
                                        <option value="bloqueada" {{='selected' if (estado or 'todos') == 'bloqueada' else ''}}>Bloqueada</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtros avanzados de saldo -->
                        <div class="row">
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Moneda</label>
                                    <select name="moneda_saldo" class="form-control">
                                        <option value="VES" {{='selected' if (moneda_saldo or 'VES') == 'VES' else ''}}>VES</option>
                                        <option value="USD" {{='selected' if (moneda_saldo or 'VES') == 'USD' else ''}}>USD</option>
                                        <option value="EUR" {{='selected' if (moneda_saldo or 'VES') == 'EUR' else ''}}>EUR</option>
                                        <option value="USDT" {{='selected' if (moneda_saldo or 'VES') == 'USDT' else ''}}>USDT</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Saldo mínimo</label>
                                    <input type="number" name="saldo_min" class="form-control" 
                                           placeholder="0.00" step="0.01" min="0" value="{{=XML(saldo_min or '', sanitize=True)}}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Saldo máximo</label>
                                    <input type="number" name="saldo_max" class="form-control" 
                                           placeholder="999999.99" step="0.01" min="0" value="{{=XML(saldo_max or '', sanitize=True)}}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div>
                                        <button type="submit" class="btn btn-primary me-2">
                                            <i class="fas fa-search me-1"></i>Buscar
                                        </button>
                                        <a href="{{=URL('cuentas', 'listar_todas')}}" class="btn btn-secondary">
                                            <i class="fas fa-times me-1"></i>Limpiar
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas de cuentas -->
    {{if stats:}}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">{{=stats.total}}</h5>
                    <p class="card-text">Total Cuentas</p>
                    <i class="fas fa-university fa-2x text-primary"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-success">{{=stats.activas}}</h5>
                    <p class="card-text">Cuentas Activas</p>
                    <i class="fas fa-check-circle fa-2x text-success"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-danger">{{=stats.inactivas}}</h5>
                    <p class="card-text">Cuentas Inactivas</p>
                    <i class="fas fa-times-circle fa-2x text-danger"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-info">{{=stats.corrientes}}</h5>
                    <p class="card-text">Cuentas Corrientes</p>
                    <i class="fas fa-credit-card fa-2x text-info"></i>
                </div>
            </div>
        </div>
    </div>
    {{pass}}

    <!-- Lista de cuentas -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Lista de Cuentas
                    </h5>
                    <a href="{{=URL('cuentas', 'crear')}}" class="btn btn-success">
                        <i class="fas fa-plus me-1"></i>Nueva Cuenta
                    </a>
                </div>
                <div class="card-body">
                    <!-- Indicador de carga -->
                    <div id="loading-indicator" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <div class="mt-3">
                            <h5 class="text-muted">Cargando cuentas...</h5>
                            <p class="text-muted mb-0">Por favor espere mientras se cargan los datos</p>
                        </div>
                    </div>
                    
                    <div id="table-container" class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Número de Cuenta</th>
                                    <th>Cliente</th>
                                    <th>Cédula</th>
                                    <th>Tipo</th>
                                    <th>Moneda</th>
                                    <th>Saldo</th>
                                    <th>Estado</th>
                                    <th>Fecha Creación</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{if cuentas:}}
                                    {{for cuenta in cuentas:}}
                                    <tr>
                                        <td>
                                            <code>{{=cuenta.cuentas.numero_cuenta}}</code>
                                        </td>
                                        <td>
                                            {{=cuenta.auth_user.first_name}} {{=cuenta.auth_user.last_name}}
                                        </td>
                                        <td>{{=cuenta.clientes.cedula}}</td>
                                        <td>
                                            <span class="badge bg-info">{{=cuenta.cuentas.tipo_cuenta.title()}}</span>
                                        </td>
                                        <td>
                                            {{moneda = cuenta.cuentas.moneda if hasattr(cuenta.cuentas, 'moneda') and cuenta.cuentas.moneda else 'VES'}}
                                            {{if moneda == 'VES':}}
                                                <span class="badge bg-primary">
                                                    <i class="fas fa-coins me-1"></i>VES
                                                </span>
                                            {{elif moneda == 'USD':}}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-dollar-sign me-1"></i>USD
                                                </span>
                                            {{elif moneda == 'EUR':}}
                                                <span class="badge bg-warning text-dark">
                                                    <i class="fas fa-euro-sign me-1"></i>EUR
                                                </span>
                                            {{elif moneda == 'USDT':}}
                                                <span class="badge bg-info">
                                                    <i class="fas fa-coins me-1"></i>USDT
                                                </span>
                                            {{else:}}
                                                <span class="badge bg-secondary">{{=moneda}}</span>
                                            {{pass}}
                                        </td>
                                        <td class="text-end">
                                            {{saldo = float(cuenta.cuentas.saldo) if hasattr(cuenta.cuentas, 'saldo') and cuenta.cuentas.saldo else 0}}
                                            <strong>{{="{:,.2f}".format(saldo)}}</strong>
                                        </td>
                                        <td>
                                            {{if cuenta.cuentas.estado == 'activa':}}
                                                <span class="badge bg-success">Activa</span>
                                            {{elif cuenta.cuentas.estado == 'inactiva':}}
                                                <span class="badge bg-danger">Inactiva</span>
                                            {{elif cuenta.cuentas.estado == 'bloqueada':}}
                                                <span class="badge bg-warning">Bloqueada</span>
                                            {{else:}}
                                                <span class="badge bg-secondary">{{=cuenta.cuentas.estado.title()}}</span>
                                            {{pass}}
                                        </td>
                                        <td>
                                            {{=cuenta.cuentas.fecha_creacion.strftime('%d/%m/%Y') if cuenta.cuentas.fecha_creacion else 'N/A'}}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="{{=URL('cuentas', 'gestionar', args=[cuenta.cuentas.id])}}" 
                                                   class="btn btn-sm btn-info" title="Gestionar cuenta">
                                                    <i class="fas fa-cog"></i>
                                                </a>
                                                <a href="{{=URL('cuentas', 'detalle', args=[cuenta.cuentas.id])}}" 
                                                   class="btn btn-sm btn-primary" title="Ver detalles">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {{pass}}
                                {{else:}}
                                    <tr>
                                        <td colspan="10" class="text-center py-5">
                                            {{if buscar or numero_cuenta or (estado and estado != 'todos') or (tipo and tipo != 'todos') or saldo_min or saldo_max:}}
                                                <!-- Mensaje cuando los filtros no devuelven resultados -->
                                                <div class="empty-state-filtered">
                                                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                                    <h4 class="text-muted">Sin resultados</h4>
                                                    <p class="text-muted mb-3">
                                                        No se encontraron cuentas que coincidan con los filtros aplicados.
                                                        <br>
                                                        <small>
                                                            {{if buscar and buscar.strip():}}
                                                                Búsqueda general: "<strong>{{=buscar}}</strong>"<br>
                                                            {{pass}}
                                                            {{if numero_cuenta and numero_cuenta.strip():}}
                                                                Número de cuenta: "<strong>{{=numero_cuenta}}</strong>"<br>
                                                            {{pass}}
                                                            {{if estado and estado != 'todos':}}
                                                                Estado: <strong>{{=estado.title()}}</strong><br>
                                                            {{pass}}
                                                            {{if tipo and tipo != 'todos':}}
                                                                Tipo: <strong>{{=tipo.title()}}</strong><br>
                                                            {{pass}}
                                                            {{if saldo_min:}}
                                                                Saldo mínimo: <strong>{{=saldo_min}} {{=moneda_saldo or 'VES'}}</strong><br>
                                                            {{pass}}
                                                            {{if saldo_max:}}
                                                                Saldo máximo: <strong>{{=saldo_max}} {{=moneda_saldo or 'VES'}}</strong><br>
                                                            {{pass}}
                                                        </small>
                                                    </p>
                                                    <div class="d-flex justify-content-center gap-2">
                                                        <a href="{{=URL('cuentas', 'listar_todas')}}" class="btn btn-outline-primary">
                                                            <i class="fas fa-times me-1"></i>Limpiar Filtros
                                                        </a>
                                                        <a href="{{=URL('clientes', 'listar')}}" class="btn btn-info">
                                                            <i class="fas fa-users me-1"></i>Ver Clientes
                                                        </a>
                                                    </div>
                                                </div>
                                            {{else:}}
                                                <!-- Mensaje cuando no hay cuentas registradas -->
                                                <div class="empty-state-no-data">
                                                    <i class="fas fa-university fa-3x text-muted mb-3"></i>
                                                    <h4 class="text-muted">No hay cuentas registradas</h4>
                                                    <p class="text-muted mb-3">
                                                        El sistema aún no tiene cuentas bancarias registradas.
                                                        <br>
                                                        <small>Para crear cuentas, primero debe tener clientes registrados en el sistema.</small>
                                                    </p>
                                                    <div class="d-flex justify-content-center gap-2">
                                                        <a href="{{=URL('clientes', 'listar')}}" class="btn btn-primary btn-lg">
                                                            <i class="fas fa-users me-2"></i>Ver Clientes
                                                        </a>
                                                        <a href="{{=URL('clientes', 'registrar')}}" class="btn btn-success">
                                                            <i class="fas fa-plus me-1"></i>Registrar Cliente
                                                        </a>
                                                        <a href="{{=URL('default', 'dashboard')}}" class="btn btn-outline-secondary">
                                                            <i class="fas fa-home me-1"></i>Dashboard
                                                        </a>
                                                    </div>
                                                    <div class="mt-4">
                                                        <small class="text-muted">
                                                            <i class="fas fa-info-circle me-1"></i>
                                                            Las cuentas se crean automáticamente al registrar clientes o pueden crearse manualmente desde la gestión de clientes.
                                                        </small>
                                                    </div>
                                                </div>
                                            {{pass}}
                                        </td>
                                    </tr>
                                {{pass}}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Paginación -->
                {{if total_pages > 1:}}
                <div class="card-footer">
                    <nav aria-label="Paginación de cuentas">
                        <ul class="pagination justify-content-center mb-0">
                            {{if page > 1:}}
                                <li class="page-item">
                                    <a class="page-link" href="{{=URL('cuentas', 'listar_todas', vars={'page': page-1, 'buscar': buscar or '', 'numero_cuenta': numero_cuenta or '', 'estado': estado or 'todos', 'tipo': tipo or 'todos', 'saldo_min': saldo_min or '', 'saldo_max': saldo_max or '', 'moneda_saldo': moneda_saldo or 'VES'})}}">
                                        <i class="fas fa-chevron-left"></i> Anterior
                                    </a>
                                </li>
                            {{pass}}
                            
                            {{for p in range(max(1, page-2), min(total_pages+1, page+3)):}}
                                <li class="page-item {{='active' if p == page else ''}}">
                                    <a class="page-link" href="{{=URL('cuentas', 'listar_todas', vars={'page': p, 'buscar': buscar or '', 'numero_cuenta': numero_cuenta or '', 'estado': estado or 'todos', 'tipo': tipo or 'todos', 'saldo_min': saldo_min or '', 'saldo_max': saldo_max or '', 'moneda_saldo': moneda_saldo or 'VES'})}}">
                                        {{=p}}
                                    </a>
                                </li>
                            {{pass}}
                            
                            {{if page < total_pages:}}
                                <li class="page-item">
                                    <a class="page-link" href="{{=URL('cuentas', 'listar_todas', vars={'page': page+1, 'buscar': buscar or '', 'numero_cuenta': numero_cuenta or '', 'estado': estado or 'todos', 'tipo': tipo or 'todos', 'saldo_min': saldo_min or '', 'saldo_max': saldo_max or '', 'moneda_saldo': moneda_saldo or 'VES'})}}">
                                        Siguiente <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            {{pass}}
                        </ul>
                    </nav>
                    
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            Página {{=page}} de {{=total_pages}} - Total: {{=total_cuentas}} cuentas
                        </small>
                    </div>
                </div>
                {{pass}}
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos específicos para la gestión de cuentas */
.page-header {
    background: linear-gradient(135deg, var(--color-primario, #2563eb) 0%, var(--color-secundario, #06b6d4) 100%);
    color: white;
    padding: 2rem;
    border-radius: 1rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.page-header h1 {
    color: white !important;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.page-header .lead {
    color: rgba(255, 255, 255, 0.9) !important;
    margin: 0;
}

/* Estilos para indicadores de carga */
.loading-overlay {
    position: relative;
}

.loading-overlay::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    z-index: 10;
    display: none;
}

.loading-overlay.loading::before {
    display: block;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

#loading-indicator {
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

/* Estilos para estados vacíos */
.empty-state-filtered,
.empty-state-no-data {
    padding: 2rem;
    max-width: 500px;
    margin: 0 auto;
}

.empty-state-filtered i,
.empty-state-no-data i {
    opacity: 0.6;
}

.empty-state-filtered h4,
.empty-state-no-data h4 {
    font-weight: 600;
    margin-bottom: 1rem;
}

.empty-state-filtered p,
.empty-state-no-data p {
    line-height: 1.6;
}

.empty-state-filtered .btn,
.empty-state-no-data .btn {
    border-radius: 0.5rem;
    font-weight: 500;
}

.empty-state-no-data .btn-lg {
    padding: 0.75rem 2rem;
    font-size: 1.1rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mostrar indicador de carga al enviar formularios de búsqueda
    const searchForms = document.querySelectorAll('form[method="GET"]');
    const loadingIndicator = document.getElementById('loading-indicator');
    const tableContainer = document.getElementById('table-container');
    
    searchForms.forEach(function(form) {
        form.addEventListener('submit', function() {
            showLoadingIndicator();
        });
    });
    
    // Mostrar indicador de carga al hacer clic en enlaces de paginación
    const paginationLinks = document.querySelectorAll('.pagination a');
    paginationLinks.forEach(function(link) {
        link.addEventListener('click', function() {
            showLoadingIndicator();
        });
    });
    
    function showLoadingIndicator() {
        if (loadingIndicator && tableContainer) {
            loadingIndicator.style.display = 'flex';
            tableContainer.style.display = 'none';
        }
    }
    
    // Simular tiempo de carga para consultas que podrían ser lentas
    const urlParams = new URLSearchParams(window.location.search);
    const hasFilters = urlParams.get('buscar') || urlParams.get('numero_cuenta') || 
                      urlParams.get('estado') || urlParams.get('tipo') || 
                      urlParams.get('saldo_min') || urlParams.get('saldo_max');
    
    if (hasFilters) {
        // Si hay filtros aplicados, mostrar brevemente el indicador de carga
        showLoadingIndicator();
        setTimeout(function() {
            if (loadingIndicator && tableContainer) {
                loadingIndicator.style.display = 'none';
                tableContainer.style.display = 'block';
            }
        }, 500);
    }
});
</script>