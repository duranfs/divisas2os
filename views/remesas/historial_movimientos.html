{{extend 'layout.html'}}

<div class="container-fluid">
  <div class="page-header">
    <h2>Historial de Movimientos de Remesas</h2>
  </div>
  
  <!-- Filtros -->
  <div class="panel panel-default">
    <div class="panel-body">
      <form method="GET" class="form-inline">
        <div class="form-group">
          <label>Desde:</label>
          <input type="date" name="fecha_desde" class="form-control" value="{{=fecha_desde}}">
        </div>
        <div class="form-group">
          <label>Hasta:</label>
          <input type="date" name="fecha_hasta" class="form-control" value="{{=fecha_hasta}}">
        </div>
        <div class="form-group">
          <label>Tipo:</label>
          <select name="tipo" class="form-control">
            <option value="TODOS" {{='selected' if tipo_filtro=='TODOS' else ''}}>Todos</option>
            <option value="RECEPCION" {{='selected' if tipo_filtro=='RECEPCION' else ''}}>Recepción</option>
            <option value="VENTA" {{='selected' if tipo_filtro=='VENTA' else ''}}>Venta</option>
            <option value="AJUSTE" {{='selected' if tipo_filtro=='AJUSTE' else ''}}>Ajuste</option>
            <option value="DEVOLUCION" {{='selected' if tipo_filtro=='DEVOLUCION' else ''}}>Devolución</option>
            <option value="RESERVA" {{='selected' if tipo_filtro=='RESERVA' else ''}}>Reserva</option>
            <option value="LIBERACION" {{='selected' if tipo_filtro=='LIBERACION' else ''}}>Liberación</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Filtrar</button>
        <a href="{{=URL('historial_movimientos')}}" class="btn btn-default">Limpiar</a>
      </form>
    </div>
  </div>
  
  <!-- Resumen -->
  <div class="alert alert-info">
    <strong>Total de movimientos:</strong> {{=len(movimientos)}}
  </div>
  
  <!-- Tabla de movimientos -->
  {{if movimientos:}}
  <div class="table-responsive">
    <table class="table table-striped table-bordered table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha</th>
          <th>Tipo</th>
          <th>Moneda</th>
          <th>Monto</th>
          <th>Saldo Anterior</th>
          <th>Saldo Nuevo</th>
          <th>Descripción</th>
          <th>Transacción</th>
        </tr>
      </thead>
      <tbody>
        {{for row in movimientos:}}
        {{mov = row.movimientos_remesas}}
        {{remesa = row.remesas_diarias}}
        <tr>
          <td>{{=mov.id}}</td>
          <td>{{=mov.fecha_movimiento.strftime('%Y-%m-%d %H:%M') if mov.fecha_movimiento else 'N/A'}}</td>
          <td>
            {{if mov.tipo_movimiento == 'RECEPCION':}}
              <span class="label label-success">Recepción</span>
            {{elif mov.tipo_movimiento == 'VENTA':}}
              <span class="label label-warning">Venta</span>
            {{elif mov.tipo_movimiento == 'AJUSTE':}}
              <span class="label label-info">Ajuste</span>
            {{elif mov.tipo_movimiento == 'DEVOLUCION':}}
              <span class="label label-primary">Devolución</span>
            {{elif mov.tipo_movimiento == 'RESERVA':}}
              <span class="label label-default">Reserva</span>
            {{elif mov.tipo_movimiento == 'LIBERACION':}}
              <span class="label label-default">Liberación</span>
            {{else:}}
              <span class="label label-default">{{=mov.tipo_movimiento}}</span>
            {{pass}}
          </td>
          <td>{{=remesa.moneda if remesa else 'N/A'}}</td>
          <td class="text-right">
            <strong>{{='{:,.2f}'.format(float(mov.monto)) if mov.monto else '0.00'}}</strong>
          </td>
          <td class="text-right">
            {{='{:,.2f}'.format(float(mov.saldo_anterior)) if mov.saldo_anterior else '0.00'}}
          </td>
          <td class="text-right">
            {{='{:,.2f}'.format(float(mov.saldo_nuevo)) if mov.saldo_nuevo else '0.00'}}
          </td>
          <td>{{=mov.descripcion or '-'}}</td>
          <td>
            {{if mov.transaccion_id:}}
              <a href="{{=URL('cuentas', 'detalle', args=[mov.transaccion_id])}}" class="btn btn-xs btn-info">
                Ver #{{=mov.transaccion_id}}
              </a>
            {{else:}}
              -
            {{pass}}
          </td>
        </tr>
        {{pass}}
      </tbody>
    </table>
  </div>
  {{else:}}
  <div class="alert alert-warning">
    <strong>No hay movimientos para mostrar.</strong>
    <p>Intente ajustar los filtros de fecha o verifique que existan movimientos registrados.</p>
  </div>
  {{pass}}
  
  <!-- Botón para volver -->
  <div class="form-group">
    <a href="{{=URL('index')}}" class="btn btn-default">
      <i class="glyphicon glyphicon-arrow-left"></i> Volver al Dashboard
    </a>
  </div>
</div>
