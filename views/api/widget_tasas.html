<!-- Widget de Tasas Actuales para Dashboard -->
<!-- Requisitos: 1.3, 8.4 -->

<div class="card bg-dark border-warning mb-4" id="widget-tasas">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">
            <i class="fas fa-chart-line"></i> 
            Tasas de Cambio Actuales
            <small class="float-right">
                <button class="btn btn-sm btn-outline-dark" onclick="actualizarWidgetTasas()" id="btn-refresh-widget">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </small>
        </h5>
    </div>
    <div class="card-body p-3">
        <div id="contenido-widget-tasas">
            <div class="text-center">
                <div class="spinner-border text-warning" role="status">
                    <span class="sr-only">Cargando...</span>
                </div>
                <p class="mt-2 mb-0">Cargando tasas...</p>
            </div>
        </div>
    </div>
</div>

<script>
// Función para cargar el widget de tasas
function cargarWidgetTasas() {
    $.ajax({
        url: '{{=URL("api", "consultar_tasas_actuales")}}',
        method: 'GET',
        success: function(data) {
            if (data.success) {
                var tasas = data.tasas;
                var fechaHora = new Date(tasas.fecha + ' ' + tasas.hora).toLocaleString('es-VE');
                
                // Determinar color de estado según la fuente
                var colorEstado = 'success';
                var iconoEstado = 'check-circle';
                if (tasas.fuente.includes('Respaldo') || tasas.fuente.includes('Histórico')) {
                    colorEstado = 'warning';
                    iconoEstado = 'exclamation-triangle';
                } else if (tasas.fuente.includes('Error') || tasas.fuente.includes('Defecto')) {
                    colorEstado = 'danger';
                    iconoEstado = 'times-circle';
                }
                
                var html = `
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="text-center p-3 bg-success rounded">
                                <h6 class="text-white mb-1">USD/VES</h6>
                                <h3 class="text-white mb-1">${parseFloat(tasas.usd_ves).toFixed(4)}</h3>
                                <small class="text-light">Bolívares por Dólar</small>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="text-center p-3 bg-primary rounded">
                                <h6 class="text-white mb-1">EUR/VES</h6>
                                <h3 class="text-white mb-1">${parseFloat(tasas.eur_ves).toFixed(4)}</h3>
                                <small class="text-light">Bolívares por Euro</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> 
                                    ${fechaHora}
                                </small>
                                <small class="text-${colorEstado}">
                                    <i class="fas fa-${iconoEstado}"></i> 
                                    ${tasas.fuente}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
                
                $('#contenido-widget-tasas').html(html);
                
                // Agregar efecto de actualización exitosa
                $('#widget-tasas').removeClass('border-danger border-warning').addClass('border-success');
                setTimeout(function() {
                    $('#widget-tasas').removeClass('border-success').addClass('border-warning');
                }, 2000);
                
            } else {
                $('#contenido-widget-tasas').html(`
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Error cargando tasas: ${data.mensaje || 'Error desconocido'}
                    </div>
                `);
                $('#widget-tasas').removeClass('border-warning border-success').addClass('border-danger');
            }
        },
        error: function(xhr, status, error) {
            $('#contenido-widget-tasas').html(`
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Error de conexión al cargar tasas
                </div>
            `);
            $('#widget-tasas').removeClass('border-warning border-success').addClass('border-danger');
        }
    });
}

// Función para actualizar manualmente el widget
function actualizarWidgetTasas() {
    $('#btn-refresh-widget').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
    
    $('#contenido-widget-tasas').html(`
        <div class="text-center">
            <div class="spinner-border text-warning" role="status">
                <span class="sr-only">Actualizando...</span>
            </div>
            <p class="mt-2 mb-0">Actualizando tasas...</p>
        </div>
    `);
    
    // Simular un pequeño delay para mejor UX
    setTimeout(function() {
        cargarWidgetTasas();
        $('#btn-refresh-widget').prop('disabled', false).html('<i class="fas fa-sync-alt"></i>');
    }, 1000);
}

// Cargar widget al inicio
$(document).ready(function() {
    cargarWidgetTasas();
    
    // Actualizar automáticamente cada 5 minutos
    setInterval(cargarWidgetTasas, 300000);
});
</script>

<style>
#widget-tasas {
    transition: border-color 0.3s ease;
}

#widget-tasas .card-body {
    min-height: 120px;
}

.bg-success, .bg-primary {
    background: linear-gradient(135deg, var(--bs-success) 0%, var(--bs-success-dark, #198754) 100%) !important;
}

.bg-primary {
    background: linear-gradient(135deg, var(--bs-primary) 0%, var(--bs-primary-dark, #0d6efd) 100%) !important;
}

.rounded {
    border-radius: 8px !important;
}

#btn-refresh-widget {
    padding: 2px 6px;
    font-size: 0.8rem;
}

.spinner-border {
    width: 1.5rem;
    height: 1.5rem;
}
</style>