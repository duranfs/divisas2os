{{extend 'layout.html'}}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-history"></i> Historial de Transacciones
                {{if es_admin:}}
                <span class="badge badge-warning">Administrador</span>
                {{pass}}
            </h2>
        </div>
    </div>

    <!-- Filtros de Búsqueda -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">
                <i class="fas fa-filter"></i> Filtros de Consulta
            </h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{=URL('reportes', 'historial_transacciones')}}">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="fecha_desde">Fecha Desde:</label>
                            <input type="date" class="form-control" id="fecha_desde" name="fecha_desde" 
                                   value="{{=filtros.get('fecha_desde', '')}}">
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="fecha_hasta">Fecha Hasta:</label>
                            <input type="date" class="form-control" id="fecha_hasta" name="fecha_hasta" 
                                   value="{{=filtros.get('fecha_hasta', '')}}">
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="tipo_operacion">Tipo de Operación:</label>
                            <select class="form-control" id="tipo_operacion" name="tipo_operacion">
                                <option value="todos" {{='selected' if filtros.get('tipo_operacion') == 'todos' else ''}}>Todos</option>
                                <option value="compra" {{='selected' if filtros.get('tipo_operacion') == 'compra' else ''}}>Compra</option>
                                <option value="venta" {{='selected' if filtros.get('tipo_operacion') == 'venta' else ''}}>Venta</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="moneda">Moneda:</label>
                            <select class="form-control" id="moneda" name="moneda">
                                <option value="todas" {{='selected' if filtros.get('moneda') == 'todas' else ''}}>Todas</option>
                                <option value="VES" {{='selected' if filtros.get('moneda') == 'VES' else ''}}>VES</option>
                                <option value="USD" {{='selected' if filtros.get('moneda') == 'USD' else ''}}>USD</option>
                                <option value="EUR" {{='selected' if filtros.get('moneda') == 'EUR' else ''}}>EUR</option>
                            </select>
                        </div>
                    </div>
                    
                    {{if es_admin and clientes_lista:}}
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="cliente_id">Cliente:</label>
                            <select class="form-control" id="cliente_id" name="cliente_id">
                                <option value="">Todos los clientes</option>
                                {{for cliente in clientes_lista:}}
                                <option value="{{=cliente.clientes.id}}" 
                                        {{='selected' if filtros.get('cliente_id') == str(cliente.clientes.id) else ''}}>
                                    {{=cliente.clientes.cedula}} - {{=cliente.auth_user.first_name}} {{=cliente.auth_user.last_name}}
                                </option>
                                {{pass}}
                            </select>
                        </div>
                    </div>
                    {{pass}}
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <a href="{{=URL('reportes', 'historial_transacciones')}}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Limpiar Filtros
                        </a>
                        
                        <!-- Botones de Exportación -->
                        <div class="btn-group float-right" role="group">
                            <button type="button" class="btn btn-outline-danger" onclick="exportarPDF()">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            {{if es_admin:}}
                            <button type="button" class="btn btn-outline-success" onclick="exportarExcel()">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                            {{pass}}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de Transacciones -->
    <div class="card">
        <div class="card-header" style="background-color: #FF8C00; color: white;">
            <h5 class="mb-0">
                <i class="fas fa-table"></i> Resultados de la Consulta
                {{if transacciones:}}
                <span class="badge badge-light">{{=len(transacciones)}} registros</span>
                {{pass}}
            </h5>
        </div>
        <div class="card-body">
            {{if transacciones:}}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th>Fecha</th>
                            <th>Comprobante</th>
                            {{if es_admin:}}
                            <th>Cliente</th>
                            {{pass}}
                            <th>Cuenta</th>
                            <th>Tipo</th>
                            <th>Origen</th>
                            <th>Destino</th>
                            <th>Tasa</th>
                            <th>Comisión</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{for transaccion in transacciones:}}
                        <tr>
                            <td>
                                <small>{{=transaccion.transacciones.fecha_transaccion.strftime('%d/%m/%Y')}}</small><br>
                                <small class="text-muted">{{=transaccion.transacciones.fecha_transaccion.strftime('%H:%M:%S')}}</small>
                            </td>
                            <td>
                                <code>{{=transaccion.transacciones.numero_comprobante}}</code>
                            </td>
                            {{if es_admin:}}
                            <td>
                                <small>{{=transaccion.clientes.cedula}}</small><br>
                                <small class="text-muted">{{=transaccion.auth_user.first_name}} {{=transaccion.auth_user.last_name}}</small>
                            </td>
                            {{pass}}
                            <td>
                                <small>***{{=transaccion.cuentas.numero_cuenta[-4:]}}</small>
                            </td>
                            <td>
                                {{if transaccion.transacciones.tipo_operacion == 'compra':}}
                                <span class="badge badge-success">
                                    <i class="fas fa-arrow-up"></i> Compra
                                </span>
                                {{else:}}
                                <span class="badge badge-info">
                                    <i class="fas fa-arrow-down"></i> Venta
                                </span>
                                {{pass}}
                            </td>
                            <td>
                                <strong>{{="{:,.2f}".format(float(transaccion.transacciones.monto_origen))}}</strong>
                                <small class="text-muted">{{=transaccion.transacciones.moneda_origen}}</small>
                            </td>
                            <td>
                                <strong>{{="{:,.2f}".format(float(transaccion.transacciones.monto_destino))}}</strong>
                                <small class="text-muted">{{=transaccion.transacciones.moneda_destino}}</small>
                            </td>
                            <td>
                                <small>{{="{:,.4f}".format(float(transaccion.transacciones.tasa_aplicada))}}</small>
                            </td>
                            <td>
                                <small>{{="{:,.2f}".format(float(transaccion.transacciones.comision))}} VES</small>
                            </td>
                            <td>
                                {{if transaccion.transacciones.estado == 'completada':}}
                                <span class="badge badge-success">Completada</span>
                                {{elif transaccion.transacciones.estado == 'pendiente':}}
                                <span class="badge badge-warning">Pendiente</span>
                                {{elif transaccion.transacciones.estado == 'cancelada':}}
                                <span class="badge badge-danger">Cancelada</span>
                                {{else:}}
                                <span class="badge badge-secondary">{{=transaccion.transacciones.estado.title()}}</span>
                                {{pass}}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{=URL('divisas', 'comprobante', args=[transaccion.transacciones.id])}}" 
                                       class="btn btn-outline-primary btn-sm" title="Ver Comprobante">
                                        <i class="fas fa-receipt"></i>
                                    </a>
                                    {{if transaccion.transacciones.observaciones:}}
                                    <button type="button" class="btn btn-outline-info btn-sm" 
                                            title="{{=transaccion.transacciones.observaciones}}"
                                            data-toggle="tooltip">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    {{pass}}
                                </div>
                            </td>
                        </tr>
                        {{pass}}
                    </tbody>
                </table>
            </div>
            
            <!-- Resumen de Resultados -->
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">Resumen de Consulta</h6>
                            {{
                            total_transacciones = len(transacciones)
                            total_compras = len([t for t in transacciones if t.transacciones.tipo_operacion == 'compra'])
                            total_ventas = len([t for t in transacciones if t.transacciones.tipo_operacion == 'venta'])
                            total_comisiones = sum([float(t.transacciones.comision) for t in transacciones])
                            }}
                            <p class="card-text">
                                <strong>Total de transacciones:</strong> {{=total_transacciones}}<br>
                                <strong>Compras:</strong> {{=total_compras}} | <strong>Ventas:</strong> {{=total_ventas}}<br>
                                <strong>Total comisiones:</strong> {{="{:,.2f}".format(total_comisiones)}} VES
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">Información</h6>
                            <p class="card-text">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> 
                                    Mostrando los primeros 100 registros que coinciden con los filtros.<br>
                                    Use filtros más específicos para refinar la búsqueda.
                                </small>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            {{else:}}
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No se encontraron transacciones</h5>
                <p class="text-muted">
                    Intente ajustar los filtros de búsqueda o verifique el rango de fechas seleccionado.
                </p>
                <a href="{{=URL('reportes', 'historial_transacciones')}}" class="btn btn-primary">
                    <i class="fas fa-refresh"></i> Mostrar Todas
                </a>
            </div>
            {{pass}}
        </div>
    </div>
</div>

<script>
// Inicializar tooltips
$(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip();
});

// Función para exportar a PDF
function exportarPDF() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{=URL("reportes", "exportar_pdf")}}';
    
    // Agregar parámetros actuales
    const params = {
        'tipo_reporte': 'transacciones',
        'fecha_desde': document.getElementById('fecha_desde').value,
        'fecha_hasta': document.getElementById('fecha_hasta').value
    };
    
    for (const key in params) {
        if (params[key]) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = params[key];
            form.appendChild(input);
        }
    }
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}

// Función para exportar a Excel (solo admin)
function exportarExcel() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{=URL("reportes", "exportar_excel")}}';
    
    // Agregar parámetros actuales
    const params = {
        'tipo_reporte': 'transacciones',
        'fecha_desde': document.getElementById('fecha_desde').value,
        'fecha_hasta': document.getElementById('fecha_hasta').value
    };
    
    for (const key in params) {
        if (params[key]) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = params[key];
            form.appendChild(input);
        }
    }
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}

// Establecer fechas por defecto si están vacías
document.addEventListener('DOMContentLoaded', function() {
    const fechaDesde = document.getElementById('fecha_desde');
    const fechaHasta = document.getElementById('fecha_hasta');
    
    if (!fechaDesde.value && !fechaHasta.value) {
        const hoy = new Date();
        const haceUnMes = new Date();
        haceUnMes.setMonth(hoy.getMonth() - 1);
        
        fechaDesde.value = haceUnMes.toISOString().split('T')[0];
        fechaHasta.value = hoy.toISOString().split('T')[0];
    }
});
</script>