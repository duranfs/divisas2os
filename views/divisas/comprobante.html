{{extend 'layout.html'}}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{=URL('divisas', 'index')}}">Divisas</a></li>
                    <li class="breadcrumb-item"><a href="{{=URL('divisas', 'historial_transacciones')}}">Historial</a></li>
                    <li class="breadcrumb-item active">Comprobante</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card border-success" id="comprobante-transaccion">
                <div class="card-header bg-success text-white text-center">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-check-circle"></i> Comprobante de Transacción
                    </h4>
                    <p class="mb-0">{{=transaccion.tipo_operacion.upper()}} DE DIVISAS</p>
                </div>
                
                <div class="card-body">
                    <!-- Información del Cliente -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6><i class="fas fa-user"></i> Información del Cliente</h6>
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <td><strong>Cliente:</strong></td>
                                    <td>{{=auth.user.first_name}} {{=auth.user.last_name}}</td>
                                </tr>
                                <tr>
                                    <td><strong>Cédula:</strong></td>
                                    <td>{{=cliente.cedula}}</td>
                                </tr>
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td>{{=auth.user.email}}</td>
                                </tr>
                                <tr>
                                    <td><strong>Cuenta:</strong></td>
                                    <td>{{=cuenta.numero_cuenta}}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-receipt"></i> Detalles de la Transacción</h6>
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <td><strong>Comprobante:</strong></td>
                                    <td class="text-primary"><strong>{{=transaccion.numero_comprobante}}</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Fecha:</strong></td>
                                    <td>{{=transaccion.fecha_transaccion.strftime("%d/%m/%Y") if transaccion.fecha_transaccion else 'N/A'}}</td>
                                </tr>
                                <tr>
                                    <td><strong>Hora:</strong></td>
                                    <td>{{=transaccion.fecha_transaccion.strftime("%H:%M:%S") if transaccion.fecha_transaccion else 'N/A'}}</td>
                                </tr>
                                <tr>
                                    <td><strong>Estado:</strong></td>
                                    <td>
                                        {{if transaccion.estado == 'completada':}}
                                        <span class="badge badge-success">COMPLETADA</span>
                                        {{else:}}
                                        <span class="badge badge-warning">{{=transaccion.estado.upper() if transaccion.estado else 'PENDIENTE'}}</span>
                                        {{pass}}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Detalles de la Operación -->
                    <div class="card bg-light">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-calculator"></i> Detalles de la Operación</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <div class="border-right">
                                        <h6>Monto {{=transaccion.tipo_operacion == 'compra' and 'Debitado' or 'Vendido'}}</h6>
                                        <h4 class="text-danger">
                                            {{="{:,.2f}".format(float(transaccion.monto_origen)) if transaccion.monto_origen else '0.00'}} 
                                            {{=transaccion.moneda_origen}}
                                        </h4>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="border-right">
                                        <h6>Tasa Aplicada</h6>
                                        <h4 class="text-info">
                                            {{="{:,.4f}".format(float(transaccion.tasa_aplicada)) if transaccion.tasa_aplicada else '0.0000'}}
                                        </h4>
                                        <small class="text-muted">
                                            {{=transaccion.moneda_origen}}/{{=transaccion.moneda_destino}}
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h6>Monto {{=transaccion.tipo_operacion == 'compra' and 'Recibido' or 'Acreditado'}}</h6>
                                    <h4 class="text-success">
                                        {{="{:,.2f}".format(float(transaccion.monto_destino)) if transaccion.monto_destino else '0.00'}} 
                                        {{=transaccion.moneda_destino}}
                                    </h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Desglose de Comisiones -->
                    <div class="card bg-light mt-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-percent"></i> Desglose de Comisiones</h6>
                        </div>
                        <div class="card-body">
                            {{if transaccion.tipo_operacion == 'compra':}}
                                <table class="table table-sm">
                                    <tr>
                                        <td>Monto base:</td>
                                        <td class="text-right">{{="{:,.2f}".format(float(transaccion.monto_origen)) if transaccion.monto_origen else '0.00'}} VES</td>
                                    </tr>
                                    <tr>
                                        <td>Comisión (0.5%):</td>
                                        <td class="text-right">{{="{:,.2f}".format(float(transaccion.comision)) if transaccion.comision else '0.00'}} VES</td>
                                    </tr>
                                    <tr class="table-active">
                                        <td><strong>Total debitado:</strong></td>
                                        <td class="text-right"><strong>{{="{:,.2f}".format(float(transaccion.monto_origen) + float(transaccion.comision)) if transaccion.monto_origen and transaccion.comision else '0.00'}} VES</strong></td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>Recibido:</strong></td>
                                        <td class="text-right"><strong>{{="{:,.2f}".format(float(transaccion.monto_destino)) if transaccion.monto_destino else '0.00'}} {{=transaccion.moneda_destino}}</strong></td>
                                    </tr>
                                </table>
                            {{else:}}
                                <table class="table table-sm">
                                    <tr>
                                        <td>Monto vendido:</td>
                                        <td class="text-right">{{="{:,.2f}".format(float(transaccion.monto_origen)) if transaccion.monto_origen else '0.00'}} {{=transaccion.moneda_origen}}</td>
                                    </tr>
                                    <tr>
                                        <td>Monto bruto en VES:</td>
                                        <td class="text-right">{{="{:,.2f}".format(float(transaccion.monto_destino) + float(transaccion.comision)) if transaccion.monto_destino and transaccion.comision else '0.00'}} VES</td>
                                    </tr>
                                    <tr>
                                        <td>Comisión (0.5%):</td>
                                        <td class="text-right">{{="{:,.2f}".format(float(transaccion.comision)) if transaccion.comision else '0.00'}} VES</td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>Total acreditado:</strong></td>
                                        <td class="text-right"><strong>{{="{:,.2f}".format(float(transaccion.monto_destino)) if transaccion.monto_destino else '0.00'}} VES</strong></td>
                                    </tr>
                                </table>
                            {{pass}}
                        </div>
                    </div>

                    <!-- Observaciones -->
                    {{if transaccion.observaciones:}}
                    <div class="card bg-light mt-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-sticky-note"></i> Observaciones</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">{{=transaccion.observaciones}}</p>
                        </div>
                    </div>
                    {{pass}}

                    <!-- Botones de Acción -->
                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-primary" onclick="window.print()">
                            <i class="fas fa-print"></i> Imprimir Comprobante
                        </button>
                        <a href="{{=URL('divisas', 'historial_transacciones')}}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Volver al Historial
                        </a>
                        <button type="button" class="btn btn-info" onclick="copiarComprobante('{{=transaccion.numero_comprobante}}')">
                            <i class="fas fa-copy"></i> Copiar Número
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@media print {
    body {
        background-color: #fff !important;
        color: #000 !important;
    }
    
    .card {
        border: 2px solid #000 !important;
        box-shadow: none !important;
    }
    
    .card-header {
        background-color: #f8f9fa !important;
        color: #000 !important;
        border-bottom: 2px solid #000 !important;
    }
    
    .btn {
        display: none !important;
    }
    
    .breadcrumb {
        display: none !important;
    }
    
    .text-primary, .text-success, .text-info, .text-danger {
        color: #000 !important;
    }
    
    .bg-light {
        background-color: #f8f9fa !important;
        color: #000 !important;
    }
    
    .table {
        color: #000 !important;
    }
    
    .badge {
        border: 1px solid #000 !important;
    }
}
</style>

<script>
function copiarComprobante(numeroComprobante) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(numeroComprobante).then(function() {
            alert('Número de comprobante copiado: ' + numeroComprobante);
        });
    } else {
        // Fallback para navegadores más antiguos
        const textArea = document.createElement('textarea');
        textArea.value = numeroComprobante;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Número de comprobante copiado: ' + numeroComprobante);
    }
}
</script>