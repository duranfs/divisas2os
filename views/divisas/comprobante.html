{{extend 'layout.html'}}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{=URL('divisas', 'index')}}">Divisas</a></li>
                    <li class="breadcrumb-item"><a href="{{=URL('divisas', 'historial_transacciones')}}">Historial</a></li>
                    <li class="breadcrumb-item active">Comprobante</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card border-success" id="comprobante-transaccion">
                <div class="card-header bg-success text-white text-center">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-check-circle"></i> Comprobante de Transacción
                    </h4>
                    <p class="mb-0">{{=transaccion.transacciones.tipo_operacion.upper()}} DE DIVISAS</p>
                </div>
                
                <div class="card-body">
                    <!-- Información del Cliente -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6><i class="fas fa-user"></i> Información del Cliente</h6>
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <td><strong>Cliente:</strong></td>
                                    <td>{{=auth.user.first_name}} {{=auth.user.last_name}}</td>
                                </tr>
                                <tr>
                                    <td><strong>Cédula:</strong></td>
                                    <td>{{=cliente.cedula}}</td>
                                </tr>
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td>{{=auth.user.email}}</td>
                                </tr>
                                <tr>
                                    <td><strong>Cuenta:</strong></td>
                                    <td>{{=transaccion.cuentas.numero_cuenta}}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-info-circle"></i> Información de la Transacción</h6>
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <td><strong>Comprobante:</strong></td>
                                    <td class="text-primary"><strong>{{=transaccion.transacciones.numero_comprobante}}</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Fecha:</strong></td>
                                    <td>{{=transaccion.transacciones.fecha_transaccion.strftime("%d/%m/%Y")}}</td>
                                </tr>
                                <tr>
                                    <td><strong>Hora:</strong></td>
                                    <td>{{=transaccion.transacciones.fecha_transaccion.strftime("%H:%M:%S")}}</td>
                                </tr>
                                <tr>
                                    <td><strong>Estado:</strong></td>
                                    <td>
                                        <span class="badge badge-{{='success' if transaccion.transacciones.estado == 'completada' else 'warning'}}">
                                            {{=transaccion.transacciones.estado.upper()}}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Detalles de la Operación -->
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h5 class="card-title text-center">
                                <i class="fas fa-exchange-alt"></i> Detalles de la Operación
                            </h5>
                            
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <div class="border-right">
                                        <h6>Monto {{=transaccion.transacciones.tipo_operacion == 'compra' and 'Debitado' or 'Vendido'}}</h6>
                                        <h4 class="text-danger">
                                            {{="{:,.2f}".format(float(transaccion.transacciones.monto_origen))}} 
                                            {{=transaccion.transacciones.moneda_origen}}
                                        </h4>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="border-right">
                                        <h6>Tasa Aplicada</h6>
                                        <h4 class="text-info">
                                            {{="{:,.4f}".format(float(transaccion.transacciones.tasa_aplicada))}}
                                        </h4>
                                        <small class="text-muted">
                                            {{=transaccion.transacciones.moneda_origen}}/{{=transaccion.transacciones.moneda_destino}}
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h6>Monto {{=transaccion.transacciones.tipo_operacion == 'compra' and 'Recibido' or 'Acreditado'}}</h6>
                                    <h4 class="text-success">
                                        {{="{:,.2f}".format(float(transaccion.transacciones.monto_destino))}} 
                                        {{=transaccion.transacciones.moneda_destino}}
                                    </h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen Financiero -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-calculator"></i> Cálculos</h6>
                                </div>
                                <div class="card-body">
                                    {{if transaccion.transacciones.tipo_operacion == 'compra':}}
                                        <table class="table table-sm">
                                            <tr>
                                                <td>Monto base:</td>
                                                <td class="text-right">{{="{:,.2f}".format(float(transaccion.transacciones.monto_origen))}} VES</td>
                                            </tr>
                                            <tr>
                                                <td>Comisión (0.5%):</td>
                                                <td class="text-right">{{="{:,.2f}".format(float(transaccion.transacciones.comision))}} VES</td>
                                            </tr>
                                            <tr class="table-active">
                                                <td><strong>Total debitado:</strong></td>
                                                <td class="text-right"><strong>{{="{:,.2f}".format(float(transaccion.transacciones.monto_origen) + float(transaccion.transacciones.comision))}} VES</strong></td>
                                            </tr>
                                            <tr class="table-success">
                                                <td><strong>Recibido:</strong></td>
                                                <td class="text-right"><strong>{{="{:,.2f}".format(float(transaccion.transacciones.monto_destino))}} {{=transaccion.transacciones.moneda_destino}}</strong></td>
                                            </tr>
                                        </table>
                                    {{else:}}
                                        {{
                                        valor_bruto = float(transaccion.transacciones.monto_destino) + float(transaccion.transacciones.comision)
                                        }}
                                        <table class="table table-sm">
                                            <tr>
                                                <td>Valor bruto:</td>
                                                <td class="text-right">{{="{:,.2f}".format(valor_bruto)}} VES</td>
                                            </tr>
                                            <tr>
                                                <td>Comisión (0.5%):</td>
                                                <td class="text-right">{{="{:,.2f}".format(float(transaccion.transacciones.comision))}} VES</td>
                                            </tr>
                                            <tr class="table-success">
                                                <td><strong>Neto acreditado:</strong></td>
                                                <td class="text-right"><strong>{{="{:,.2f}".format(float(transaccion.transacciones.monto_destino))}} VES</strong></td>
                                            </tr>
                                            <tr class="table-active">
                                                <td><strong>Divisa vendida:</strong></td>
                                                <td class="text-right"><strong>{{="{:,.2f}".format(float(transaccion.transacciones.monto_origen))}} {{=transaccion.transacciones.moneda_origen}}</strong></td>
                                            </tr>
                                        </table>
                                    {{pass}}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-secondary">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-sticky-note"></i> Observaciones</h6>
                                </div>
                                <div class="card-body">
                                    <p>{{=transaccion.transacciones.observaciones or 'Sin observaciones adicionales'}}</p>
                                    
                                    <hr>
                                    <h6>Información Adicional:</h6>
                                    <ul class="small">
                                        <li>Transacción procesada exitosamente</li>
                                        <li>Los fondos han sido actualizados en su cuenta</li>
                                        <li>Este comprobante es válido como respaldo de la operación</li>
                                        <li>Para consultas, conserve el número de comprobante</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Código QR y Verificación -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6><i class="fas fa-shield-alt"></i> Verificación de Autenticidad</h6>
                                    <p class="mb-2">
                                        <strong>Hash de Verificación:</strong> 
                                        <code>{{=hash(str(transaccion.transacciones.id) + transaccion.transacciones.numero_comprobante)[:16]}}</code>
                                    </p>
                                    <small class="text-muted">
                                        Este comprobante puede ser verificado en nuestras oficinas o a través de nuestro sistema en línea
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="text-center">
                        <button onclick="imprimirComprobante()" class="btn btn-primary">
                            <i class="fas fa-print"></i> Imprimir Comprobante
                        </button>
                        <button onclick="descargarPDF()" class="btn btn-secondary">
                            <i class="fas fa-file-pdf"></i> Descargar PDF
                        </button>
                        <a href="{{=URL('divisas', 'historial_transacciones')}}" class="btn btn-outline-secondary">
                            <i class="fas fa-history"></i> Ver Historial
                        </a>
                        <a href="{{=URL('divisas', 'index')}}" class="btn btn-outline-primary">
                            <i class="fas fa-home"></i> Volver al Inicio
                        </a>
                    </div>
                </div>

                <!-- Footer del Comprobante -->
                <div class="card-footer text-center text-muted">
                    <small>
                        <i class="fas fa-building"></i> Sistema de Divisas Bancario | 
                        <i class="fas fa-phone"></i> 0212-555-0123 | 
                        <i class="fas fa-envelope"></i> soporte@banco.com
                    </small>
                    <br>
                    <small>
                        Comprobante generado el {{=datetime.datetime.now().strftime("%d/%m/%Y a las %H:%M:%S")}}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estilos para impresión -->
<style>
@media print {
    .breadcrumb, .btn, .card-footer {
        display: none !important;
    }
    
    .card {
        border: 2px solid #000 !important;
        box-shadow: none !important;
    }
    
    .card-header {
        background-color: #000 !important;
        color: #fff !important;
        -webkit-print-color-adjust: exact;
    }
    
    .text-primary, .text-success, .text-info, .text-danger {
        color: #000 !important;
    }
    
    .bg-light {
        background-color: #f8f9fa !important;
        -webkit-print-color-adjust: exact;
    }
    
    .border-right {
        border-right: 1px solid #000 !important;
    }
    
    body {
        font-size: 12px;
    }
}
</style>

<script>
function imprimirComprobante() {
    window.print();
}

function descargarPDF() {
    // Esta función requeriría implementación adicional con una librería como jsPDF
    // Por ahora, mostrar mensaje informativo
    alert('Función de descarga PDF en desarrollo. Por favor, use la opción de imprimir y seleccione "Guardar como PDF" en su navegador.');
}

// Función para copiar número de comprobante
function copiarComprobante() {
    const numeroComprobante = '{{=transaccion.transacciones.numero_comprobante}}';
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(numeroComprobante).then(function() {
            alert('Número de comprobante copiado al portapapeles');
        });
    } else {
        // Fallback para navegadores más antiguos
        const textArea = document.createElement('textarea');
        textArea.value = numeroComprobante;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Número de comprobante copiado al portapapeles');
    }
}

// Agregar funcionalidad de clic al número de comprobante
$(document).ready(function() {
    $('.text-primary').click(function() {
        if ($(this).text().includes('{{=transaccion.transacciones.numero_comprobante}}')) {
            copiarComprobante();
        }
    });
    
    // Tooltip para el número de comprobante
    $('.text-primary').attr('title', 'Haga clic para copiar').css('cursor', 'pointer');
});
</script>