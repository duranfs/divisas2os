{{extend 'layout.html'}}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-history"></i> Historial de Transacciones</h2>
            <p class="lead">Consulte todas sus operaciones de divisas</p>
        </div>
    </div>

    {{if response.flash:}}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info alert-dismissible fade show">
                {{=response.flash}}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        </div>
    </div>
    {{pass}}

    <!-- Filtros de Búsqueda -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter"></i> Filtros de Búsqueda
                    </h5>
                </div>
                <div class="card-body">
                    <form method="get" id="form-filtros">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="fecha_desde">Fecha Desde:</label>
                                    <input type="date" name="fecha_desde" id="fecha_desde" 
                                           class="form-control" value="{{=filtros.get('fecha_desde', '') if filtros else ''}}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="fecha_hasta">Fecha Hasta:</label>
                                    <input type="date" name="fecha_hasta" id="fecha_hasta" 
                                           class="form-control" value="{{=filtros.get('fecha_hasta', '') if filtros else ''}}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="tipo_operacion">Tipo de Operación:</label>
                                    <select name="tipo_operacion" id="tipo_operacion" class="form-control">
                                        <option value="todos">Todas</option>
                                        <option value="compra">Compras</option>
                                        <option value="venta">Ventas</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="moneda">Moneda:</label>
                                    <select name="moneda" id="moneda" class="form-control">
                                        <option value="todas">Todas</option>
                                        <option value="VES">VES</option>
                                        <option value="USD">USD</option>
                                        <option value="EUR">EUR</option>
                                        <option value="USDT">USDT</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        {{if cuentas_cliente:}}
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="cuenta_id">
                                        <i class="fas fa-filter"></i> Filtrar por Cuenta Específica:
                                    </label>
                                    <select name="cuenta_id" id="cuenta_id" class="form-control">
                                        <option value="">Todas mis cuentas</option>
                                        {{for cuenta in cuentas_cliente:}}
                                        <option value="{{=cuenta.id}}" {{='selected' if filtros and filtros.get('cuenta_id') == str(cuenta.id) else ''}}>
                                            {{=cuenta.numero_cuenta}} - {{=cuenta.moneda}} (Saldo: {{="{:,.2f}".format(float(cuenta.saldo))}})
                                        </option>
                                        {{pass}}
                                    </select>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle"></i> 
                                        Filtre las transacciones donde esta cuenta aparezca como origen o destino
                                    </div>
                                </div>
                            </div>
                        </div>
                        {{pass}}
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                                <a href="{{=URL('divisas', 'historial_transacciones')}}" class="btn btn-secondary">
                                    <i class="fas fa-eraser"></i> Limpiar Filtros
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen de Resultados -->
    {{if transacciones:}}
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 
                Se encontraron <strong>{{=len(transacciones)}}</strong> transacciones
            </div>
        </div>
    </div>
    {{pass}}

    <!-- Tabla de Transacciones -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table"></i> Transacciones
                    </h5>
                </div>
                <div class="card-body">
                    {{if transacciones:}}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tabla-transacciones">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Fecha/Hora</th>
                                    <th>Comprobante</th>
                                    <th>Tipo</th>
                                    <th>Cuenta Origen</th>
                                    <th>Cuenta Destino</th>
                                    <th>Monto Origen</th>
                                    <th>Monto Destino</th>
                                    <th>Tasa</th>
                                    <th>Comisión</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{for transaccion in transacciones:}}
                                <tr>
                                    <td>
                                        <small>
                                            {{=transaccion.transacciones.fecha_transaccion.strftime("%d/%m/%Y") if transaccion.transacciones.fecha_transaccion else 'N/A'}}<br>
                                            {{=transaccion.transacciones.fecha_transaccion.strftime("%H:%M:%S") if transaccion.transacciones.fecha_transaccion else ''}}
                                        </small>
                                    </td>
                                    <td>
                                        <code class="comprobante-codigo" title="Clic para copiar">
                                            {{=transaccion.transacciones.numero_comprobante if transaccion.transacciones.numero_comprobante else 'N/A'}}
                                        </code>
                                    </td>
                                    <td>
                                        {{if transaccion.transacciones.tipo_operacion == 'compra':}}
                                        <span class="badge badge-success">COMPRA</span>
                                        {{else:}}
                                        <span class="badge badge-info">VENTA</span>
                                        {{pass}}
                                    </td>
                                    <td>
                                        <small>
                                            {{
                                            # Obtener cuenta origen desde el alias
                                            numero_origen = transaccion.get('numero_cuenta_origen', 'N/A')
                                            moneda_origen = transaccion.get('moneda_cuenta_origen', transaccion.transacciones.moneda_origen if transaccion.transacciones.moneda_origen else '')
                                            }}
                                            <strong>{{=numero_origen}}</strong><br>
                                            <span class="badge badge-secondary">{{=moneda_origen}}</span>
                                        </small>
                                    </td>
                                    <td>
                                        <small>
                                            {{
                                            # Obtener cuenta destino desde el alias
                                            numero_destino = transaccion.get('numero_cuenta_destino', 'N/A')
                                            moneda_destino = transaccion.get('moneda_cuenta_destino', transaccion.transacciones.moneda_destino if transaccion.transacciones.moneda_destino else '')
                                            }}
                                            <strong>{{=numero_destino}}</strong><br>
                                            <span class="badge badge-secondary">{{=moneda_destino}}</span>
                                        </small>
                                    </td>
                                    <td class="text-right">
                                        <strong>{{="{:,.2f}".format(float(transaccion.transacciones.monto_origen)) if transaccion.transacciones.monto_origen else '0.00'}}</strong><br>
                                        <small class="text-muted">{{=transaccion.transacciones.moneda_origen}}</small>
                                    </td>
                                    <td class="text-right">
                                        <strong class="text-success">{{="{:,.2f}".format(float(transaccion.transacciones.monto_destino)) if transaccion.transacciones.monto_destino else '0.00'}}</strong><br>
                                        <small class="text-muted">{{=transaccion.transacciones.moneda_destino}}</small>
                                    </td>
                                    <td class="text-center">
                                        <small>{{="{:,.4f}".format(float(transaccion.transacciones.tasa_aplicada)) if transaccion.transacciones.tasa_aplicada else '0.0000'}}</small>
                                    </td>
                                    <td class="text-right">
                                        <small class="text-warning">{{="{:,.2f}".format(float(transaccion.transacciones.comision)) if transaccion.transacciones.comision else '0.00'}}</small>
                                    </td>
                                    <td>
                                        {{if transaccion.transacciones.estado == 'completada':}}
                                        <span class="badge badge-success">COMPLETADA</span>
                                        {{else:}}
                                        <span class="badge badge-warning">{{=transaccion.transacciones.estado.upper() if transaccion.transacciones.estado else 'PENDIENTE'}}</span>
                                        {{pass}}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{=URL('divisas', 'comprobante', args=[transaccion.transacciones.id])}}" 
                                               class="btn btn-outline-primary btn-sm" title="Ver Comprobante">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                    onclick="copiarComprobante('{{=transaccion.transacciones.numero_comprobante if transaccion.transacciones.numero_comprobante else 'N/A'}}')" 
                                                    title="Copiar Número">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {{pass}}
                            </tbody>
                        </table>
                    </div>
                    {{else:}}
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No se encontraron transacciones</h5>
                        <p class="text-muted">
                            Aún no ha realizado transacciones de divisas.<br>
                            <a href="{{=URL('divisas', 'index')}}" class="btn btn-primary mt-2">
                                <i class="fas fa-plus"></i> Realizar Primera Transacción
                            </a>
                        </p>
                    </div>
                    {{pass}}
                </div>
            </div>
        </div>
    </div>

    {{if transacciones:}}
    <!-- Estadísticas Rápidas -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar"></i> Resumen del Período
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="card border-success">
                                <div class="card-body">
                                    <h6>Total Transacciones</h6>
                                    <h4 class="text-primary">{{=len(transacciones)}}</h4>
                                    <small class="text-muted">En el período</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-info">
                                <div class="card-body">
                                    <h6>Compras</h6>
                                    <h4 class="text-success">{{=len([t for t in transacciones if t.transacciones.tipo_operacion == 'compra'])}}</h4>
                                    <small class="text-muted">Operaciones</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-warning">
                                <div class="card-body">
                                    <h6>Ventas</h6>
                                    <h4 class="text-info">{{=len([t for t in transacciones if t.transacciones.tipo_operacion == 'venta'])}}</h4>
                                    <small class="text-muted">Operaciones</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {{pass}}
</div>

<script>
$(document).ready(function() {
    // Configurar fechas por defecto (último mes)
    if (!$('#fecha_desde').val() && !$('#fecha_hasta').val()) {
        const hoy = new Date();
        const haceUnMes = new Date();
        haceUnMes.setMonth(haceUnMes.getMonth() - 1);
        
        $('#fecha_hasta').val(hoy.toISOString().split('T')[0]);
        $('#fecha_desde').val(haceUnMes.toISOString().split('T')[0]);
    }
    
    // Hacer códigos de comprobante clickeables
    $('.comprobante-codigo').click(function() {
        copiarComprobante($(this).text().trim());
    }).css('cursor', 'pointer');
    
    // Configurar valores de filtros desde el servidor
    {{if filtros:}}
    {{if filtros.get('tipo_operacion'):}}
    $('#tipo_operacion').val('{{=filtros["tipo_operacion"]}}');
    {{pass}}
    {{if filtros.get('moneda'):}}
    $('#moneda').val('{{=filtros["moneda"]}}');
    {{pass}}
    {{if filtros.get('cuenta_id'):}}
    $('#cuenta_id').val('{{=filtros["cuenta_id"]}}');
    {{pass}}
    {{pass}}
});

function copiarComprobante(numeroComprobante) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(numeroComprobante).then(function() {
            alert('Número de comprobante copiado: ' + numeroComprobante);
        });
    } else {
        // Fallback para navegadores más antiguos
        const textArea = document.createElement('textarea');
        textArea.value = numeroComprobante;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Número de comprobante copiado: ' + numeroComprobante);
    }
}
</script>