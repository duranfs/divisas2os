{{extend 'layout.html'}}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{=URL('divisas', 'index')}}">Divisas</a></li>
                    <li class="breadcrumb-item active">Historial de Transacciones</li>
                </ol>
            </nav>
            
            <h2><i class="fas fa-history"></i> Historial de Transacciones</h2>
            <p class="lead">Consulte todas sus operaciones de divisas</p>
        </div>
    </div>

    {{if response.flash:}}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info alert-dismissible fade show">
                {{=response.flash}}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        </div>
    </div>
    {{pass}}

    <!-- Filtros de Búsqueda -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter"></i> Filtros de Búsqueda
                    </h5>
                </div>
                <div class="card-body">
                    <form method="get" id="form-filtros">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="fecha_desde">Fecha Desde:</label>
                                    <input type="date" name="fecha_desde" id="fecha_desde" 
                                           class="form-control" value="{{=filtros.get('fecha_desde', '')}}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="fecha_hasta">Fecha Hasta:</label>
                                    <input type="date" name="fecha_hasta" id="fecha_hasta" 
                                           class="form-control" value="{{=filtros.get('fecha_hasta', '')}}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="tipo_operacion">Tipo de Operación:</label>
                                    <select name="tipo_operacion" id="tipo_operacion" class="form-control">
                                        <option value="todos" {{='selected' if filtros.get('tipo_operacion') == 'todos' else ''}}>Todas</option>
                                        <option value="compra" {{='selected' if filtros.get('tipo_operacion') == 'compra' else ''}}>Compras</option>
                                        <option value="venta" {{='selected' if filtros.get('tipo_operacion') == 'venta' else ''}}>Ventas</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="moneda">Moneda:</label>
                                    <select name="moneda" id="moneda" class="form-control">
                                        <option value="todas" {{='selected' if filtros.get('moneda') == 'todas' else ''}}>Todas</option>
                                        <option value="VES" {{='selected' if filtros.get('moneda') == 'VES' else ''}}>VES</option>
                                        <option value="USD" {{='selected' if filtros.get('moneda') == 'USD' else ''}}>USD</option>
                                        <option value="EUR" {{='selected' if filtros.get('moneda') == 'EUR' else ''}}>EUR</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                                <a href="{{=URL('divisas', 'historial_transacciones')}}" class="btn btn-secondary">
                                    <i class="fas fa-eraser"></i> Limpiar Filtros
                                </a>
                                <button type="button" class="btn btn-success" onclick="exportarExcel()">
                                    <i class="fas fa-file-excel"></i> Exportar Excel
                                </button>
                                <button type="button" class="btn btn-danger" onclick="exportarPDF()">
                                    <i class="fas fa-file-pdf"></i> Exportar PDF
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen de Resultados -->
    {{if transacciones:}}
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 
                Se encontraron <strong>{{=len(transacciones)}}</strong> transacciones
                {{if filtros.get('fecha_desde') or filtros.get('fecha_hasta'):}}
                    {{if filtros.get('fecha_desde') and filtros.get('fecha_hasta'):}}
                        entre el {{=filtros['fecha_desde']}} y el {{=filtros['fecha_hasta']}}
                    {{elif filtros.get('fecha_desde'):}}
                        desde el {{=filtros['fecha_desde']}}
                    {{elif filtros.get('fecha_hasta'):}}
                        hasta el {{=filtros['fecha_hasta']}}
                    {{pass}}
                {{pass}}
            </div>
        </div>
    </div>
    {{pass}}

    <!-- Tabla de Transacciones -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table"></i> Transacciones
                    </h5>
                </div>
                <div class="card-body">
                    {{if transacciones:}}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tabla-transacciones">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Fecha/Hora</th>
                                    <th>Comprobante</th>
                                    <th>Tipo</th>
                                    <th>Cuenta</th>
                                    <th>Origen</th>
                                    <th>Destino</th>
                                    <th>Tasa</th>
                                    <th>Comisión</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{for transaccion in transacciones:}}
                                <tr>
                                    <td>
                                        <small>
                                            {{=transaccion.transacciones.fecha_transaccion.strftime("%d/%m/%Y")}}<br>
                                            {{=transaccion.transacciones.fecha_transaccion.strftime("%H:%M:%S")}}
                                        </small>
                                    </td>
                                    <td>
                                        <code class="comprobante-codigo" title="Clic para copiar">
                                            {{=transaccion.transacciones.numero_comprobante}}
                                        </code>
                                    </td>
                                    <td>
                                        <span class="badge badge-{{='success' if transaccion.transacciones.tipo_operacion == 'compra' else 'info'}}">
                                            {{=transaccion.transacciones.tipo_operacion.upper()}}
                                        </span>
                                    </td>
                                    <td>
                                        <small>{{=transaccion.cuentas.numero_cuenta}}</small>
                                    </td>
                                    <td class="text-right">
                                        <strong>{{="{:,.2f}".format(float(transaccion.transacciones.monto_origen))}}</strong><br>
                                        <small class="text-muted">{{=transaccion.transacciones.moneda_origen}}</small>
                                    </td>
                                    <td class="text-right">
                                        <strong class="text-success">{{="{:,.2f}".format(float(transaccion.transacciones.monto_destino))}}</strong><br>
                                        <small class="text-muted">{{=transaccion.transacciones.moneda_destino}}</small>
                                    </td>
                                    <td class="text-center">
                                        <small>{{="{:,.4f}".format(float(transaccion.transacciones.tasa_aplicada))}}</small>
                                    </td>
                                    <td class="text-right">
                                        <small class="text-warning">{{="{:,.2f}".format(float(transaccion.transacciones.comision))}}</small>
                                    </td>
                                    <td>
                                        <span class="badge badge-{{='success' if transaccion.transacciones.estado == 'completada' else 'warning'}}">
                                            {{=transaccion.transacciones.estado.upper()}}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{=URL('divisas', 'comprobante', args=[transaccion.transacciones.id])}}" 
                                               class="btn btn-outline-primary btn-sm" title="Ver Comprobante">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                    onclick="copiarComprobante('{{=transaccion.transacciones.numero_comprobante}}')" 
                                                    title="Copiar Número">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {{pass}}
                            </tbody>
                        </table>
                    </div>
                    {{else:}}
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No se encontraron transacciones</h5>
                        <p class="text-muted">
                            {{if filtros.get('fecha_desde') or filtros.get('fecha_hasta') or filtros.get('tipo_operacion') != 'todos' or filtros.get('moneda') != 'todas':}}
                                Intente ajustar los filtros de búsqueda o 
                                <a href="{{=URL('divisas', 'historial_transacciones')}}">limpiar todos los filtros</a>
                            {{else:}}
                                Aún no ha realizado transacciones de divisas.<br>
                                <a href="{{=URL('divisas', 'index')}}" class="btn btn-primary mt-2">
                                    <i class="fas fa-plus"></i> Realizar Primera Transacción
                                </a>
                            {{pass}}
                        </p>
                    </div>
                    {{pass}}
                </div>
            </div>
        </div>
    </div>

    {{if transacciones:}}
    <!-- Estadísticas Rápidas -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar"></i> Resumen del Período
                    </h5>
                </div>
                <div class="card-body">
                    {{
                    # Calcular estadísticas
                    total_compras = sum([float(t.transacciones.monto_origen) for t in transacciones if t.transacciones.tipo_operacion == 'compra'])
                    total_ventas = sum([float(t.transacciones.monto_origen) for t in transacciones if t.transacciones.tipo_operacion == 'venta'])
                    total_comisiones = sum([float(t.transacciones.comision) for t in transacciones])
                    num_compras = len([t for t in transacciones if t.transacciones.tipo_operacion == 'compra'])
                    num_ventas = len([t for t in transacciones if t.transacciones.tipo_operacion == 'venta'])
                    }}
                    
                    <div class="row text-center">
                        <div class="col-md-2">
                            <div class="card border-success">
                                <div class="card-body">
                                    <h6>Compras</h6>
                                    <h4 class="text-success">{{=num_compras}}</h4>
                                    <small class="text-muted">{{="{:,.2f}".format(total_compras)}} VES</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card border-info">
                                <div class="card-body">
                                    <h6>Ventas</h6>
                                    <h4 class="text-info">{{=num_ventas}}</h4>
                                    <small class="text-muted">{{="{:,.2f}".format(total_ventas)}} USD/EUR</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card border-warning">
                                <div class="card-body">
                                    <h6>Comisiones</h6>
                                    <h4 class="text-warning">{{="{:,.2f}".format(total_comisiones)}}</h4>
                                    <small class="text-muted">VES</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h6>Total Transacciones</h6>
                                    <h4 class="text-primary">{{=len(transacciones)}}</h4>
                                    <small class="text-muted">En el período</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-secondary">
                                <div class="card-body">
                                    <h6>Promedio Diario</h6>
                                    {{
                                    dias_periodo = 1
                                    if filtros.get('fecha_desde') and filtros.get('fecha_hasta'):
                                        from datetime import datetime
                                        fecha_desde = datetime.strptime(filtros['fecha_desde'], '%Y-%m-%d')
                                        fecha_hasta = datetime.strptime(filtros['fecha_hasta'], '%Y-%m-%d')
                                        dias_periodo = max(1, (fecha_hasta - fecha_desde).days + 1)
                                    promedio = len(transacciones) / dias_periodo
                                    }}
                                    <h4 class="text-secondary">{{="{:.1f}".format(promedio)}}</h4>
                                    <small class="text-muted">Transacciones</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {{pass}}
</div>

<script>
$(document).ready(function() {
    // Inicializar DataTable si está disponible
    if ($.fn.DataTable) {
        $('#tabla-transacciones').DataTable({
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json"
            },
            "order": [[ 0, "desc" ]], // Ordenar por fecha descendente
            "pageLength": 25,
            "responsive": true,
            "columnDefs": [
                { "orderable": false, "targets": [9] } // Columna de acciones no ordenable
            ]
        });
    }
    
    // Configurar fechas por defecto (último mes)
    if (!$('#fecha_desde').val() && !$('#fecha_hasta').val()) {
        const hoy = new Date();
        const haceUnMes = new Date();
        haceUnMes.setMonth(haceUnMes.getMonth() - 1);
        
        $('#fecha_hasta').val(hoy.toISOString().split('T')[0]);
        $('#fecha_desde').val(haceUnMes.toISOString().split('T')[0]);
    }
    
    // Hacer códigos de comprobante clickeables
    $('.comprobante-codigo').click(function() {
        copiarComprobante($(this).text().trim());
    }).css('cursor', 'pointer');
});

function copiarComprobante(numeroComprobante) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(numeroComprobante).then(function() {
            mostrarToast('Número de comprobante copiado', 'success');
        });
    } else {
        // Fallback para navegadores más antiguos
        const textArea = document.createElement('textarea');
        textArea.value = numeroComprobante;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        mostrarToast('Número de comprobante copiado', 'success');
    }
}

function exportarExcel() {
    // Obtener parámetros actuales
    const params = new URLSearchParams(window.location.search);
    params.set('formato', 'excel');
    
    // Crear URL de exportación
    const url = '{{=URL("divisas", "exportar_historial")}}?' + params.toString();
    
    // Abrir en nueva ventana para descarga
    window.open(url, '_blank');
}

function exportarPDF() {
    // Obtener parámetros actuales
    const params = new URLSearchParams(window.location.search);
    params.set('formato', 'pdf');
    
    // Crear URL de exportación
    const url = '{{=URL("divisas", "exportar_historial")}}?' + params.toString();
    
    // Abrir en nueva ventana para descarga
    window.open(url, '_blank');
}

function mostrarToast(mensaje, tipo = 'info') {
    // Si existe toastr, usarlo
    if (typeof toastr !== 'undefined') {
        toastr[tipo](mensaje);
    } else {
        // Fallback con alert
        alert(mensaje);
    }
}

// Auto-submit del formulario cuando cambian las fechas
$('#fecha_desde, #fecha_hasta').change(function() {
    // Opcional: auto-submit después de seleccionar ambas fechas
    // $('#form-filtros').submit();
});
</script>