{{extend 'layout.html'}}

<div class="container-fluid">
    <!-- Header de la página -->
    <div class="page-header fade-in-up">
        <div class="row align-items-center">
            <div class="col-12">
                <h1>
                    <i class="fas fa-users me-3"></i>Gestión de Clientes
                </h1>
                <p class="lead mb-0">Administración y consulta de clientes bancarios</p>
            </div>
        </div>
    </div>

    {{if response.flash:}}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info alert-dismissible fade show">
                {{=response.flash}}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>
    {{pass}}

    <!-- Filtros de búsqueda funcionales -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filtros de Búsqueda
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{{=URL('clientes', 'listar')}}">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Buscar por nombre</label>
                                    <input type="text" name="buscar" class="form-control" 
                                           placeholder="Nombre del cliente" value="{{=XML(buscar or '', sanitize=True)}}" maxlength="100">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Buscar por cédula</label>
                                    <input type="text" name="cedula" class="form-control" 
                                           placeholder="Número de cédula" value="{{=XML(cedula or '', sanitize=True)}}" maxlength="20">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Buscar por email</label>
                                    <input type="email" name="email" class="form-control" 
                                           placeholder="Email del cliente" value="{{=XML(email or '', sanitize=True)}}" maxlength="100">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Estado</label>
                                    <select name="estado" class="form-control">
                                        <option value="todos" {{='selected' if (estado_filtro or 'todos') == 'todos' else ''}}>Todos los estados</option>
                                        <option value="activo" {{='selected' if (estado_filtro or 'todos') == 'activo' else ''}}>Activo</option>
                                        <option value="inactivo" {{='selected' if (estado_filtro or 'todos') == 'inactivo' else ''}}>Inactivo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Fecha registro desde</label>
                                    <input type="date" name="fecha_desde" class="form-control" 
                                           value="{{=XML(fecha_desde or '', sanitize=True)}}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Fecha registro hasta</label>
                                    <input type="date" name="fecha_hasta" class="form-control" 
                                           value="{{=XML(fecha_hasta or '', sanitize=True)}}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div>
                                        <button type="submit" class="btn btn-primary me-2">
                                            <i class="fas fa-search me-1"></i>Buscar
                                        </button>
                                        <a href="{{=URL('clientes', 'listar')}}" class="btn btn-secondary">
                                            <i class="fas fa-times me-1"></i>Limpiar
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Lista de clientes -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Lista de Clientes
                    </h5>
                    <a href="{{=URL('clientes', 'registrar')}}" class="btn btn-success">
                        <i class="fas fa-plus me-1"></i>Nuevo Cliente
                    </a>
                </div>
                <div class="card-body">
                    <!-- Indicador de carga -->
                    <div id="loading-indicator" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <div class="mt-3">
                            <h5 class="text-muted">Cargando clientes...</h5>
                            <p class="text-muted mb-0">Por favor espere mientras se cargan los datos</p>
                        </div>
                    </div>
                    
                    <div id="table-container" class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Cédula</th>
                                    <th>Email</th>
                                    <th>Estado</th>
                                    <th>Fecha Registro</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{if clientes:}}
                                    {{for cliente in clientes:}}
                                    <tr>
                                        <td>{{=cliente.clientes.id}}</td>
                                        <td>{{=cliente.auth_user.first_name}} {{=cliente.auth_user.last_name}}</td>
                                        <td>{{=cliente.clientes.cedula}}</td>
                                        <td>{{=cliente.auth_user.email}}</td>
                                        <td>
                                            {{if cliente.auth_user.estado == 'activo':}}
                                                <span class="badge bg-success">Activo</span>
                                            {{else:}}
                                                <span class="badge bg-danger">Inactivo</span>
                                            {{pass}}
                                        </td>
                                        <td>{{=cliente.clientes.fecha_registro.strftime('%d/%m/%Y') if cliente.clientes.fecha_registro else 'N/A'}}</td>
                                        <td>
                                            <a href="{{=URL('clientes', 'detalle', args=[cliente.clientes.id])}}" 
                                               class="btn btn-sm btn-info me-1" title="Ver detalles">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{=URL('clientes', 'editar', args=[cliente.clientes.id])}}" 
                                               class="btn btn-sm btn-warning me-1" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            {{if cliente.auth_user.estado == 'activo':}}
                                                <a href="{{=URL('clientes', 'cambiar_estado', args=[cliente.clientes.id, 'inactivo'])}}" 
                                                   class="btn btn-sm btn-outline-danger me-1" title="Inactivar cliente"
                                                   onclick="return confirm('¿Está seguro de que desea inactivar este cliente?')">
                                                    <i class="fas fa-user-slash"></i>
                                                </a>
                                            {{else:}}
                                                <a href="{{=URL('clientes', 'cambiar_estado', args=[cliente.clientes.id, 'activo'])}}" 
                                                   class="btn btn-sm btn-outline-success me-1" title="Activar cliente"
                                                   onclick="return confirm('¿Está seguro de que desea activar este cliente?')">
                                                    <i class="fas fa-user-check"></i>
                                                </a>
                                            {{pass}}
                                        </td>
                                    </tr>
                                    {{pass}}
                                {{else:}}
                                    <tr>
                                        <td colspan="7" class="text-center py-5">
                                            {{if (buscar and buscar.strip()) or (cedula and cedula.strip()) or (email and email.strip()) or (estado_filtro and estado_filtro != 'todos') or (fecha_desde and fecha_desde.strip()) or (fecha_hasta and fecha_hasta.strip()):}}
                                                <!-- Mensaje cuando los filtros no devuelven resultados -->
                                                <div class="empty-state-filtered">
                                                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                                    <h4 class="text-muted">Sin resultados</h4>
                                                    <p class="text-muted mb-3">
                                                        No se encontraron clientes que coincidan con los filtros aplicados.
                                                        <br>
                                                        <small>
                                                            {{if buscar and buscar.strip():}}
                                                                Búsqueda: "<strong>{{=buscar}}</strong>"<br>
                                                            {{pass}}
                                                            {{if cedula and cedula.strip():}}
                                                                Cédula: "<strong>{{=cedula}}</strong>"<br>
                                                            {{pass}}
                                                            {{if email and email.strip():}}
                                                                Email: "<strong>{{=email}}</strong>"<br>
                                                            {{pass}}
                                                            {{if estado_filtro and estado_filtro != 'todos':}}
                                                                Estado: <strong>{{=estado_filtro.title()}}</strong><br>
                                                            {{pass}}
                                                            {{if fecha_desde and fecha_desde.strip():}}
                                                                Desde: <strong>{{=fecha_desde}}</strong><br>
                                                            {{pass}}
                                                            {{if fecha_hasta and fecha_hasta.strip():}}
                                                                Hasta: <strong>{{=fecha_hasta}}</strong><br>
                                                            {{pass}}
                                                        </small>
                                                    </p>
                                                    <div class="d-flex justify-content-center gap-2">
                                                        <a href="{{=URL('clientes', 'listar')}}" class="btn btn-outline-primary">
                                                            <i class="fas fa-times me-1"></i>Limpiar Filtros
                                                        </a>
                                                        <a href="{{=URL('clientes', 'registrar')}}" class="btn btn-success">
                                                            <i class="fas fa-plus me-1"></i>Registrar Cliente
                                                        </a>
                                                    </div>
                                                </div>
                                            {{else:}}
                                                <!-- Mensaje cuando no hay clientes registrados -->
                                                <div class="empty-state-no-data">
                                                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                                    <h4 class="text-muted">No hay clientes registrados</h4>
                                                    <p class="text-muted mb-3">
                                                        El sistema aún no tiene clientes registrados.
                                                        <br>
                                                        <small>Comience registrando su primer cliente para empezar a usar el sistema.</small>
                                                    </p>
                                                    <div class="d-flex justify-content-center gap-2">
                                                        <a href="{{=URL('clientes', 'registrar')}}" class="btn btn-success btn-lg">
                                                            <i class="fas fa-plus me-2"></i>Registrar Primer Cliente
                                                        </a>
                                                        <a href="{{=URL('default', 'dashboard')}}" class="btn btn-outline-secondary">
                                                            <i class="fas fa-home me-1"></i>Ir al Dashboard
                                                        </a>
                                                    </div>
                                                    <div class="mt-4">
                                                        <small class="text-muted">
                                                            <i class="fas fa-info-circle me-1"></i>
                                                            ¿Necesita ayuda? Consulte la 
                                                            <a href="{{=URL('default', 'ayuda')}}" class="text-decoration-none">documentación</a>
                                                            o contacte al administrador.
                                                        </small>
                                                    </div>
                                                </div>
                                            {{pass}}
                                        </td>
                                    </tr>
                                {{pass}}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginación -->
                    {{if total_pages and total_pages > 1:}}
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted">
                            Mostrando página {{=page or 1}} de {{=total_pages}} ({{=total_clientes or 0}} clientes total)
                        </div>
                        <nav aria-label="Paginación de clientes">
                            <ul class="pagination mb-0">
                                {{if page and page > 1:}}
                                    <li class="page-item">
                                        <a class="page-link" href="{{=URL('clientes', 'listar', vars={'page': page-1, 'buscar': buscar or '', 'cedula': cedula or '', 'email': email or '', 'estado': estado_filtro or 'todos', 'fecha_desde': fecha_desde or '', 'fecha_hasta': fecha_hasta or ''})}}">
                                            <i class="fas fa-chevron-left"></i> Anterior
                                        </a>
                                    </li>
                                {{pass}}
                                
                                {{if page and total_pages:}}
                                    {{for p in range(max(1, page-2), min(total_pages+1, page+3)):}}
                                        <li class="page-item {{='active' if p == page else ''}}">
                                            <a class="page-link" href="{{=URL('clientes', 'listar', vars={'page': p, 'buscar': buscar or '', 'cedula': cedula or '', 'email': email or '', 'estado': estado_filtro or 'todos', 'fecha_desde': fecha_desde or '', 'fecha_hasta': fecha_hasta or ''})}}">
                                                {{=p}}
                                            </a>
                                        </li>
                                    {{pass}}
                                {{pass}}
                                
                                {{if page and total_pages and page < total_pages:}}
                                    <li class="page-item">
                                        <a class="page-link" href="{{=URL('clientes', 'listar', vars={'page': page+1, 'buscar': buscar or '', 'cedula': cedula or '', 'email': email or '', 'estado': estado_filtro or 'todos', 'fecha_desde': fecha_desde or '', 'fecha_hasta': fecha_hasta or ''})}}">
                                            Siguiente <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                {{pass}}
                            </ul>
                        </nav>
                    </div>
                    {{pass}}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos específicos para la gestión de clientes */
.page-header {
    background: linear-gradient(135deg, var(--color-primario, #2563eb) 0%, var(--color-secundario, #06b6d4) 100%);
    color: white;
    padding: 2rem;
    border-radius: 1rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.page-header h1 {
    color: white !important;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.page-header .lead {
    color: rgba(255, 255, 255, 0.9) !important;
    margin: 0;
}

/* Estilos para indicadores de carga */
.loading-overlay {
    position: relative;
}

.loading-overlay::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    z-index: 10;
    display: none;
}

.loading-overlay.loading::before {
    display: block;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

#loading-indicator {
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

/* Estilos para estados vacíos */
.empty-state-filtered,
.empty-state-no-data {
    padding: 2rem;
    max-width: 500px;
    margin: 0 auto;
}

.empty-state-filtered i,
.empty-state-no-data i {
    opacity: 0.6;
}

.empty-state-filtered h4,
.empty-state-no-data h4 {
    font-weight: 600;
    margin-bottom: 1rem;
}

.empty-state-filtered p,
.empty-state-no-data p {
    line-height: 1.6;
}

.empty-state-filtered .btn,
.empty-state-no-data .btn {
    border-radius: 0.5rem;
    font-weight: 500;
}

.empty-state-no-data .btn-lg {
    padding: 0.75rem 2rem;
    font-size: 1.1rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mostrar indicador de carga al enviar formularios de búsqueda
    const searchForms = document.querySelectorAll('form[method="GET"]');
    const loadingIndicator = document.getElementById('loading-indicator');
    const tableContainer = document.getElementById('table-container');
    
    searchForms.forEach(function(form) {
        form.addEventListener('submit', function() {
            showLoadingIndicator();
        });
    });
    
    // Mostrar indicador de carga al hacer clic en enlaces de paginación
    const paginationLinks = document.querySelectorAll('.pagination a');
    paginationLinks.forEach(function(link) {
        link.addEventListener('click', function() {
            showLoadingIndicator();
        });
    });
    
    function showLoadingIndicator() {
        if (loadingIndicator && tableContainer) {
            loadingIndicator.style.display = 'flex';
            tableContainer.style.display = 'none';
        }
    }
    
    // Simular tiempo de carga para consultas que podrían ser lentas
    const urlParams = new URLSearchParams(window.location.search);
    const hasFilters = urlParams.get('buscar') || urlParams.get('cedula') || 
                      urlParams.get('email') || urlParams.get('estado') || 
                      urlParams.get('fecha_desde') || urlParams.get('fecha_hasta');
    
    if (hasFilters) {
        // Si hay filtros aplicados, mostrar brevemente el indicador de carga
        showLoadingIndicator();
        setTimeout(function() {
            if (loadingIndicator && tableContainer) {
                loadingIndicator.style.display = 'none';
                tableContainer.style.display = 'block';
            }
        }, 500);
    }
});
</script>