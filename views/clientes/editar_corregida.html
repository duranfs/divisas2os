{{extend 'layout.html'}}

<div class="container-fluid">
    <!-- Header de la página -->
    <div class="page-header fade-in-up">
        <div class="row align-items-center">
            <div class="col-12">
                <h1>
                    <i class="fas fa-user-edit me-3"></i>Editar Cliente
                </h1>
                <p class="lead mb-0">Modificar información del cliente</p>
            </div>
        </div>
    </div>

    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{=URL('default', 'dashboard')}}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{=URL('clientes', 'listar')}}">Gestión de Clientes</a></li>
            {{if cliente:}}
                <li class="breadcrumb-item"><a href="{{=URL('clientes', 'detalle', args=[cliente.id])}}">Detalles</a></li>
            {{pass}}
            <li class="breadcrumb-item active">Editar Cliente</li>
        </ol>
    </nav>

    {{if response.flash:}}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info alert-dismissible fade show">
                {{=response.flash}}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>
    {{pass}}

    {{if cliente and usuario:}}
    <div class="row">
        <!-- Formulario de Edición -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-edit me-2"></i>Formulario de Edición
                    </h5>
                </div>
                <div class="card-body">
                    {{=form}}
                </div>
            </div>
        </div>
        
        <!-- Panel de Información -->
        <div class="col-md-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Información del Cliente
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">ID del Cliente:</small>
                        <div class="fw-bold">{{=cliente.id}}</div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">Estado Actual:</small>
                        <div>
                            {{if hasattr(usuario, 'estado') and usuario.estado == 'activo':}}
                                <span class="badge bg-success">
                                    <i class="fas fa-check me-1"></i>Activo
                                </span>
                            {{else:}}
                                <span class="badge bg-danger">
                                    <i class="fas fa-times me-1"></i>Inactivo
                                </span>
                            {{pass}}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">Fecha de Registro:</small>
                        <div class="fw-bold">
                            {{=cliente.fecha_registro.strftime('%d/%m/%Y') if cliente.fecha_registro else 'No disponible'}}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">Última Modificación:</small>
                        <div class="fw-bold">
                            {{=cliente.fecha_modificacion.strftime('%d/%m/%Y %H:%M') if hasattr(cliente, 'fecha_modificacion') and cliente.fecha_modificacion else 'Nunca'}}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel de Acciones -->
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-cog me-2"></i>Acciones Disponibles
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{=URL('clientes', 'detalle', args=[cliente.id])}}" class="btn btn-info">
                            <i class="fas fa-eye me-2"></i>Ver Detalles
                        </a>
                        
                        {{if hasattr(usuario, 'estado') and usuario.estado == 'activo':}}
                            <a href="{{=URL('clientes', 'cambiar_estado', args=[cliente.id, 'inactivo'])}}" 
                               class="btn btn-outline-danger"
                               onclick="return confirm('¿Está seguro de que desea inactivar este cliente?')">
                                <i class="fas fa-user-slash me-2"></i>Inactivar Cliente
                            </a>
                        {{else:}}
                            <a href="{{=URL('clientes', 'cambiar_estado', args=[cliente.id, 'activo'])}}" 
                               class="btn btn-outline-success"
                               onclick="return confirm('¿Está seguro de que desea activar este cliente?')">
                                <i class="fas fa-user-check me-2"></i>Activar Cliente
                            </a>
                        {{pass}}
                        
                        <hr>
                        
                        <a href="{{=URL('clientes', 'listar')}}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Volver a Lista
                        </a>
                        
                        <a href="{{=URL('default', 'dashboard')}}" class="btn btn-outline-primary">
                            <i class="fas fa-home me-2"></i>Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{else:}}
    <!-- Error: Cliente no encontrado -->
    <div class="row">
        <div class="col-12">
            <div class="card border-danger shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Cliente No Encontrado
                    </h5>
                </div>
                <div class="card-body text-center py-5">
                    <i class="fas fa-user-times fa-5x text-danger mb-4"></i>
                    <h4 class="text-danger mb-3">Cliente No Disponible</h4>
                    <p class="text-muted mb-4">
                        No se pudo cargar la información del cliente para editar.
                        <br>
                        Esto puede deberse a permisos insuficientes o que el cliente no exista.
                    </p>
                    <div class="mt-4">
                        <a href="{{=URL('clientes', 'listar')}}" class="btn btn-primary me-3">
                            <i class="fas fa-arrow-left me-1"></i>Volver a Lista de Clientes
                        </a>
                        <a href="{{=URL('default', 'dashboard')}}" class="btn btn-outline-secondary">
                            <i class="fas fa-home me-1"></i>Ir al Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {{pass}}
</div>

<style>
/* Estilos específicos para edición de cliente */
.page-header {
    background: linear-gradient(135deg, #FFA366 0%, #FFD700 100%);
    color: #000;
    padding: 2rem;
    border-radius: 1rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.page-header h1 {
    color: #000 !important;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.page-header .lead {
    color: rgba(0, 0, 0, 0.8) !important;
    margin: 0;
}

.card {
    transition: all 0.3s ease;
    border: none;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.card-header {
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.card-header h5,
.card-header h6 {
    font-weight: 600;
}

/* Estilos para el formulario */
.form-control:focus {
    border-color: #FFA366;
    box-shadow: 0 0 0 0.2rem rgba(255, 163, 102, 0.25);
}

.btn-primary {
    background-color: #FFA366;
    border-color: #FFA366;
}

.btn-primary:hover {
    background-color: #ff9147;
    border-color: #ff9147;
}

.form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
}

.form-text {
    font-size: 0.875rem;
    color: #6c757d;
}

/* Animaciones */
.fade-in-up {
    animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Mejoras visuales */
.shadow-sm {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
}

/* Responsive */
@media (max-width: 768px) {
    .page-header {
        padding: 1.5rem;
    }
    
    .page-header h1 {
        font-size: 1.75rem;
    }
    
    .card-body {
        padding: 1rem;
    }
}

/* Estados de validación */
.is-invalid {
    border-color: #dc3545;
}

.is-valid {
    border-color: #28a745;
}

.invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: #dc3545;
}

.valid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: #28a745;
}

/* Estilos para campos requeridos */
.required::after {
    content: " *";
    color: #dc3545;
    font-weight: bold;
}

/* Loading state */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.loading::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #FFA366;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
// JavaScript para mejorar la experiencia del usuario
document.addEventListener('DOMContentLoaded', function() {
    // Validación en tiempo real
    const form = document.querySelector('form');
    if (form) {
        const inputs = form.querySelectorAll('input, select, textarea');
        
        inputs.forEach(input => {
            input.addEventListener('blur', function() {
                validateField(this);
            });
            
            input.addEventListener('input', function() {
                if (this.classList.contains('is-invalid')) {
                    validateField(this);
                }
            });
        });
        
        // Validación al enviar
        form.addEventListener('submit', function(e) {
            let isValid = true;
            
            inputs.forEach(input => {
                if (!validateField(input)) {
                    isValid = false;
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                showAlert('Por favor, corrija los errores en el formulario antes de continuar.', 'danger');
            } else {
                // Mostrar estado de carga
                const submitBtn = form.querySelector('input[type="submit"], button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
                }
            }
        });
    }
    
    // Confirmar acciones peligrosas
    document.querySelectorAll('.btn-outline-danger').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            if (!confirm('¿Está seguro de que desea realizar esta acción?')) {
                e.preventDefault();
            }
        });
    });
    
    // Animación de entrada para las tarjetas
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('fade-in-up');
    });
});

// Función de validación de campos
function validateField(field) {
    const value = field.value.trim();
    let isValid = true;
    let message = '';
    
    // Validaciones básicas
    if (field.hasAttribute('required') && !value) {
        isValid = false;
        message = 'Este campo es requerido.';
    } else if (field.type === 'email' && value && !isValidEmail(value)) {
        isValid = false;
        message = 'Por favor, ingrese un email válido.';
    } else if (field.name === 'cedula' && value && !isValidCedula(value)) {
        isValid = false;
        message = 'Por favor, ingrese una cédula válida (ej: V-12345678).';
    } else if (field.type === 'tel' && value && !isValidPhone(value)) {
        isValid = false;
        message = 'Por favor, ingrese un teléfono válido.';
    }
    
    // Aplicar estilos de validación
    if (isValid) {
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');
        removeErrorMessage(field);
    } else {
        field.classList.remove('is-valid');
        field.classList.add('is-invalid');
        showErrorMessage(field, message);
    }
    
    return isValid;
}

// Funciones de validación específicas
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function isValidCedula(cedula) {
    const cedulaRegex = /^[VEJ]-\d{7,8}$/i;
    return cedulaRegex.test(cedula);
}

function isValidPhone(phone) {
    const phoneRegex = /^[\d\s\-\+\(\)]{10,}$/;
    return phoneRegex.test(phone);
}

// Funciones para mostrar/ocultar mensajes de error
function showErrorMessage(field, message) {
    removeErrorMessage(field);
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'invalid-feedback';
    errorDiv.textContent = message;
    
    field.parentNode.appendChild(errorDiv);
}

function removeErrorMessage(field) {
    const existingError = field.parentNode.querySelector('.invalid-feedback');
    if (existingError) {
        existingError.remove();
    }
}

// Función para mostrar alertas
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    const firstChild = container.firstElementChild;
    container.insertBefore(alertDiv, firstChild);
    
    // Auto-dismiss después de 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>