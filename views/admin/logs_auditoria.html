{{extend 'layout.html'}}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-clipboard-list"></i> Logs de Auditoría
            </h2>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-filter"></i> Filtros de Búsqueda
            </h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{=URL('admin', 'logs_auditoria')}}">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="fecha_inicio">Fecha Inicio:</label>
                            <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio" 
                                   value="{{=filtros.get('fecha_inicio', '')}}">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="fecha_fin">Fecha Fin:</label>
                            <input type="date" class="form-control" id="fecha_fin" name="fecha_fin" 
                                   value="{{=filtros.get('fecha_fin', '')}}">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="modulo">Módulo:</label>
                            <select class="form-control" id="modulo" name="modulo">
                                <option value="todos">Todos</option>
                                {{for modulo in modulos:}}
                                <option value="{{=modulo.modulo}}" 
                                        {{='selected' if filtros.get('modulo') == modulo.modulo else ''}}>
                                    {{=modulo.modulo.title()}}
                                </option>
                                {{pass}}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="accion">Acción:</label>
                            <select class="form-control" id="accion" name="accion">
                                <option value="todas">Todas</option>
                                {{for accion in acciones:}}
                                <option value="{{=accion.accion}}" 
                                        {{='selected' if filtros.get('accion') == accion.accion else ''}}>
                                    {{=accion.accion.replace('_', ' ').title()}}
                                </option>
                                {{pass}}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="resultado">Resultado:</label>
                            <select class="form-control" id="resultado" name="resultado">
                                <option value="todos">Todos</option>
                                <option value="exitoso" {{='selected' if filtros.get('resultado') == 'exitoso' else ''}}>Exitoso</option>
                                <option value="fallido" {{='selected' if filtros.get('resultado') == 'fallido' else ''}}>Fallido</option>
                                <option value="bloqueado" {{='selected' if filtros.get('resultado') == 'bloqueado' else ''}}>Bloqueado</option>
                                <option value="denegado" {{='selected' if filtros.get('resultado') == 'denegado' else ''}}>Denegado</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="usuario_id">Usuario:</label>
                            <select class="form-control" id="usuario_id" name="usuario_id">
                                <option value="todos">Todos</option>
                                {{for usuario in usuarios:}}
                                <option value="{{=usuario.id}}" 
                                        {{='selected' if filtros.get('usuario_id') == str(usuario.id) else ''}}>
                                    {{=usuario.first_name}} {{=usuario.last_name}} ({{=usuario.email}})
                                </option>
                                {{pass}}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="form-group">
                            <label>&nbsp;</label><br>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                            <a href="{{=URL('admin', 'logs_auditoria')}}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Limpiar
                            </a>
                            <a href="{{=URL('admin', 'estadisticas_auditoria')}}" class="btn btn-info">
                                <i class="fas fa-chart-bar"></i> Estadísticas
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Resultados -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list"></i> Registros de Auditoría
            </h5>
            {{if paginacion:}}
            <span class="badge badge-info">
                {{=paginacion.get('total_logs', 0)}} registros encontrados
            </span>
            {{pass}}
        </div>
        <div class="card-body p-0">
            {{if logs:}}
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="thead-dark">
                            <tr>
                                <th>Fecha/Hora</th>
                                <th>Usuario</th>
                                <th>Acción</th>
                                <th>Módulo</th>
                                <th>Tabla</th>
                                <th>IP</th>
                                <th>Resultado</th>
                                <th>Detalles</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{for log in logs:}}
                            <tr>
                                <td>
                                    <small>{{=log.fecha_accion.strftime('%d/%m/%Y')}}</small><br>
                                    <small class="text-muted">{{=log.fecha_accion.strftime('%H:%M:%S')}}</small>
                                </td>
                                <td>
                                    {{if log.usuario_id:}}
                                        {{usuario = db.auth_user(log.usuario_id)}}
                                        {{if usuario:}}
                                            <strong>{{=usuario.first_name}} {{=usuario.last_name}}</strong><br>
                                            <small class="text-muted">{{=usuario.email}}</small>
                                        {{else:}}
                                            <span class="text-muted">Usuario eliminado</span>
                                        {{pass}}
                                    {{else:}}
                                        <span class="text-muted">Sistema</span>
                                    {{pass}}
                                </td>
                                <td>
                                    <span class="badge badge-secondary">
                                        {{=log.accion.replace('_', ' ').title()}}
                                    </span>
                                </td>
                                <td>{{=log.modulo.title()}}</td>
                                <td>{{=log.tabla_afectada or '-'}}</td>
                                <td>
                                    <small>{{=log.ip_address or 'N/A'}}</small>
                                </td>
                                <td>
                                    <span class="badge badge-{{='success' if log.resultado == 'exitoso' else 'danger' if log.resultado == 'fallido' else 'warning'}}">
                                        {{=log.resultado.title()}}
                                    </span>
                                </td>
                                <td>
                                    {{if log.datos_nuevos or log.datos_anteriores or log.mensaje_error:}}
                                        <button class="btn btn-sm btn-outline-info" type="button" 
                                                data-toggle="collapse" data-target="#detalles-{{=log.id}}" 
                                                aria-expanded="false">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    {{else:}}
                                        -
                                    {{pass}}
                                </td>
                            </tr>
                            {{if log.datos_nuevos or log.datos_anteriores or log.mensaje_error:}}
                            <tr>
                                <td colspan="8" class="p-0">
                                    <div class="collapse" id="detalles-{{=log.id}}">
                                        <div class="card card-body m-2">
                                            {{if log.mensaje_error:}}
                                                <div class="alert alert-danger">
                                                    <strong>Error:</strong> {{=log.mensaje_error}}
                                                </div>
                                            {{pass}}
                                            {{if log.datos_anteriores:}}
                                                <div class="mb-2">
                                                    <strong>Datos Anteriores:</strong>
                                                    <pre class="bg-light p-2 small">{{=XML(log.datos_anteriores)}}</pre>
                                                </div>
                                            {{pass}}
                                            {{if log.datos_nuevos:}}
                                                <div class="mb-2">
                                                    <strong>Datos Nuevos:</strong>
                                                    <pre class="bg-light p-2 small">{{=XML(log.datos_nuevos)}}</pre>
                                                </div>
                                            {{pass}}
                                            {{if log.user_agent:}}
                                                <div class="mb-2">
                                                    <strong>User Agent:</strong>
                                                    <small class="text-muted">{{=log.user_agent}}</small>
                                                </div>
                                            {{pass}}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {{pass}}
                            {{pass}}
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginación -->
                {{if paginacion and paginacion.get('total_pages', 0) > 1:}}
                <div class="card-footer">
                    <nav aria-label="Paginación de logs">
                        <ul class="pagination justify-content-center mb-0">
                            {{if paginacion.get('page', 1) > 1:}}
                                <li class="page-item">
                                    <a class="page-link" href="{{=URL('admin', 'logs_auditoria', vars=dict(request.vars, page=paginacion.get('page', 1) - 1))}}">
                                        Anterior
                                    </a>
                                </li>
                            {{pass}}
                            
                            {{for i in range(max(1, paginacion.get('page', 1) - 2), min(paginacion.get('total_pages', 0) + 1, paginacion.get('page', 1) + 3)):}}
                                <li class="page-item {{='active' if i == paginacion.get('page', 1) else ''}}">
                                    <a class="page-link" href="{{=URL('admin', 'logs_auditoria', vars=dict(request.vars, page=i))}}">
                                        {{=i}}
                                    </a>
                                </li>
                            {{pass}}
                            
                            {{if paginacion.get('page', 1) < paginacion.get('total_pages', 0):}}
                                <li class="page-item">
                                    <a class="page-link" href="{{=URL('admin', 'logs_auditoria', vars=dict(request.vars, page=paginacion.get('page', 1) + 1))}}">
                                        Siguiente
                                    </a>
                                </li>
                            {{pass}}
                        </ul>
                    </nav>
                </div>
                {{pass}}
            {{else:}}
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No se encontraron registros</h5>
                    <p class="text-muted">Intente ajustar los filtros de búsqueda</p>
                </div>
            {{pass}}
        </div>
    </div>
</div>

<style>
.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.875rem;
}

.table td {
    vertical-align: middle;
    font-size: 0.875rem;
}

.badge {
    font-size: 0.75em;
}

pre {
    font-size: 0.75rem;
    max-height: 200px;
    overflow-y: auto;
}

.card-header {
    background-color: var(--color-menu);
    color: white;
}
</style>